// ==================== è§’è‰²å¡é¢æ¿UI ====================

function registerCharacterPanel(context, data, core) {
    const { calculateMaxHP, calculateMaxSAN, calculateMove, calculateBuild, calculateDamageBonus, calculateDB, rollD100 } = core;
    
    let panelElement = null;
    let isEditing = false;
    let currentEditName = '';
    let currentEditStats = null;
    
    // é¢„å®šä¹‰æŠ€èƒ½åˆ—è¡¨
    const SKILLS_LIST = {
        occupational: [
            'ä¼šè®¡', 'äººç±»å­¦', 'ä¼°ä»·', 'è€ƒå¤å­¦', 'è‰ºæœ¯', 'æ‰‹è‰º', 'ä¿¡ç”¨è¯„çº§', 'å…‹è‹é²ç¥è¯',
            'æˆå‰§', 'é©¾é©¶', 'ç”µæ°”ç»´ä¿®', 'ç”µå­å­¦', 'æ ¼æ–—(æ–—æ®´)', 'å°„å‡»(æ‰‹æª)', 'å°„å‡»(æ­¥æª)',
            'æ€¥æ•‘', 'å†å²', 'æå“', 'è·³è·ƒ', 'æ³•å¾‹', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'è†å¬', 'é”åŒ ', 'æœºæ¢°ç»´ä¿®',
            'åŒ»å­¦', 'è‡ªç„¶', 'å¯¼èˆª', 'ç¥ç§˜å­¦', 'æ“ä½œé‡å‹æœºæ¢°', 'è¯´æœ', 'æ”€çˆ¬', 'ç²¾ç¥åˆ†æ',
            'å¿ƒç†å­¦', 'éª‘æœ¯', 'ç§‘å­¦', 'å¦™æ‰‹', 'ä¾¦æŸ¥', 'æ½œè¡Œ', 'ç”Ÿå­˜', 'æ¸¸æ³³', 'æŠ•æ·', 'è¿½è¸ª'
        ],
        interest: [
            'ä¼šè®¡', 'äººç±»å­¦', 'ä¼°ä»·', 'è€ƒå¤å­¦', 'è‰ºæœ¯', 'æ‰‹è‰º', 'ä¿¡ç”¨è¯„çº§', 'å…‹è‹é²ç¥è¯',
            'æˆå‰§', 'é©¾é©¶', 'ç”µæ°”ç»´ä¿®', 'ç”µå­å­¦', 'æ ¼æ–—(æ–—æ®´)', 'å°„å‡»(æ‰‹æª)', 'å°„å‡»(æ­¥æª)',
            'æ€¥æ•‘', 'å†å²', 'æå“', 'è·³è·ƒ', 'æ³•å¾‹', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'è†å¬', 'é”åŒ ', 'æœºæ¢°ç»´ä¿®',
            'åŒ»å­¦', 'è‡ªç„¶', 'å¯¼èˆª', 'ç¥ç§˜å­¦', 'æ“ä½œé‡å‹æœºæ¢°', 'è¯´æœ', 'æ”€çˆ¬', 'ç²¾ç¥åˆ†æ',
            'å¿ƒç†å­¦', 'éª‘æœ¯', 'ç§‘å­¦', 'å¦™æ‰‹', 'ä¾¦æŸ¥', 'æ½œè¡Œ', 'ç”Ÿå­˜', 'æ¸¸æ³³', 'æŠ•æ·', 'è¿½è¸ª'
        ],
        fighting: [
            'æ ¼æ–—(æ–—æ®´)', 'æ ¼æ–—(åˆ€)', 'æ ¼æ–—(å‰‘)', 'æ ¼æ–—(æ£)', 'æ ¼æ–—(æ–§)', 
            'å°„å‡»(æ‰‹æª)', 'å°„å‡»(æ­¥æª)', 'å°„å‡»(å†²é”‹æª)', 'å°„å‡»(çŒæª)', 'æŠ•æ·'
        ]
    };
    
    // é¢„å®šä¹‰æ­¦å™¨åˆ—è¡¨
    const WEAPONS_LIST = [
        { name: 'æ‹³å¤´', skill: 'æ ¼æ–—(æ–—æ®´)', damage: '1d3+db' },
        { name: 'è¸¢', skill: 'æ ¼æ–—(æ–—æ®´)', damage: '1d6+db' },
        { name: 'å°åˆ€', skill: 'æ ¼æ–—(åˆ€)', damage: '1d4+db' },
        { name: 'çŸ­æ£', skill: 'æ ¼æ–—(æ£)', damage: '1d6+db' },
        { name: 'æ‰‹æª', skill: 'å°„å‡»(æ‰‹æª)', damage: '1d10' },
        { name: 'å·¦è½®æ‰‹æª', skill: 'å°„å‡»(æ‰‹æª)', damage: '1d10' },
        { name: 'çŒæª', skill: 'å°„å‡»(çŒæª)', damage: '2d6/1d6' },
        { name: 'æ­¥æª', skill: 'å°„å‡»(æ­¥æª)', damage: '2d6' },
        { name: 'å†²é”‹æª', skill: 'å°„å‡»(å†²é”‹æª)', damage: '1d10' },
        { name: 'æ‰‹æ¦´å¼¹', skill: 'æŠ•æ·', damage: '4d10' }
    ];
    
    // ç¤¾äº¤æŠ€èƒ½åˆ—è¡¨
    const SOCIAL_SKILLS = ['è¯´æœ', 'æå“', 'å¿ƒç†', 'ä¹”è£…', 'å¿«é€Ÿäº¤è°ˆ', 'é­…æƒ‘'];
    
    // ç§‘å­¦æŠ€èƒ½åˆ—è¡¨
    const SCIENCE_SKILLS = ['ç”Ÿç‰©', 'åŒ–å­¦', 'ç‰©ç†', 'å¤©æ–‡', 'åœ°è´¨', 'æ•°å­¦', 'è¯å­¦', 'æ°”è±¡'];
    
    // è‰ºæœ¯/å·¥è‰ºæŠ€èƒ½åˆ—è¡¨
    const CRAFT_SKILLS = ['ç»˜ç”»', 'é›•å¡‘', 'æ‘„å½±', 'å†™ä½œ', 'æ¼”å¥', 'å”±æ­Œ', 'èˆè¹ˆ', 'æœ¨å·¥', 'è£ç¼'];
    
    // å¤–è¯­åˆ—è¡¨
    const LANGUAGE_SKILLS = ['è‹±è¯­', 'æ±‰è¯­', 'æ³•è¯­', 'å¾·è¯­', 'è¥¿ç­ç‰™è¯­', 'æ‹‰ä¸è¯­', 'æ—¥è¯­', 'ä¿„è¯­', 'é˜¿æ‹‰ä¼¯è¯­'];

    // ==================== æ–°å¢ï¼šç–¯ç‹‚ç—‡çŠ¶è¡¨ ====================
    
    // å³æ—¶ç—‡çŠ¶ï¼ˆæˆ˜æ–—ä¸­ä½¿ç”¨ï¼‰
    const INSANITY_INSTANT_SYMPTOMS = [
        { id: 1, name: 'å¤±å¿†', description: 'ä¸è®°å¾—è¿‡å»å‡ åˆ†é’Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œé™·å…¥è¿·èŒ«' },
        { id: 2, name: 'å‡æ€§æ®‹ç–¾', description: 'èº«ä½“æŸéƒ¨åˆ†å¤±å»åŠŸèƒ½ï¼ˆç˜¸äº†/çäº†/å¤±å£°ï¼‰ï¼ŒæŒç»­1D10è½®' },
        { id: 3, name: 'æš´åŠ›å€¾å‘', description: 'å¯¹å‘¨å›´äººæ— å·®åˆ«æ”»å‡»ï¼Œä¸åˆ†æ•Œæˆ‘' },
        { id: 4, name: 'åæ‰§', description: 'æ€€ç–‘æ‰€æœ‰äººéƒ½åœ¨å®³è‡ªå·±ï¼Œè¯•å›¾é€ƒè·‘æˆ–æ”»å‡»' },
        { id: 5, name: 'ä»ªå¼è¡Œä¸º', description: 'å¿…é¡»é‡å¤åšæŸä¸ªåŠ¨ä½œï¼ˆæ•°æ•°/è½¬åœˆ/æ‹æ‰‹ï¼‰ï¼Œå¦åˆ™æ— æ³•è¡ŒåŠ¨' },
        { id: 6, name: 'å¹»è§‰', description: 'çœ‹åˆ°ä¸å­˜åœ¨çš„ä¸œè¥¿ï¼Œæ ¹æ®å¹»è§‰è¡ŒåŠ¨' },
        { id: 7, name: 'ææ…Œç—‡', description: 'ç–¯ç‹‚é€ƒè·‘ï¼Œè¯•å›¾è¿œç¦»ä¸€åˆ‡' },
        { id: 8, name: 'é€ƒé¿è¡Œä¸º', description: 'èœ·ç¼©è§’è½ï¼ŒæŠ±å¤´ä¸åŠ¨ï¼Œå¯¹å¤–ç•Œæ— ååº”' },
        { id: 9, name: 'ææƒ§ç—‡', description: 'å¯¹ç‰¹å®šäº‹ç‰©ï¼ˆç–¯ç‹‚æ¥æºï¼‰äº§ç”Ÿæåº¦ææƒ§' },
        { id: 10, name: 'èºç‹‚ç—‡', description: 'è¿‡åº¦å…´å¥‹ï¼Œæ‰§ç€äºæŸä»¶äº‹ç‰©' }
    ];

    // æ€»ç»“ç—‡çŠ¶ï¼ˆå‰§æœ¬ç»“æŸæ—¶ï¼‰
    const INSANITY_SUMMARY_SYMPTOMS = [
        { id: 1, name: 'å¤±å¿†', description: 'æœ‰1D6å°æ—¶çš„ç©ºç™½æœŸï¼Œå®Œå…¨ä¸è®°å¾—å‘ç”Ÿäº†ä»€ä¹ˆ' },
        { id: 2, name: 'å‡æ€§æ®‹ç–¾', description: 'ç•™ä¸‹æ°¸ä¹…ç—‡çŠ¶ï¼Œå¦‚é•¿æœŸè·›è„šã€è§†åŠ›æ¨¡ç³Šç­‰' },
        { id: 3, name: 'æš´åŠ›å€¾å‘', description: 'é†’æ¥åä¸è®°å¾—ï¼Œä½†å‘¨å›´äººå®³æ€•ä½ ' },
        { id: 4, name: 'åæ‰§', description: 'ä¹‹åä¼šå¯¹ç‰¹å®šç±»å‹çš„äººèµ·ç–‘å¿ƒ' },
        { id: 5, name: 'ä»ªå¼è¡Œä¸º', description: 'å…»æˆæ€ªç™–ï¼Œæ¯å¤©å¿…é¡»åšæŸä¸ªåŠ¨ä½œ' },
        { id: 6, name: 'å¹»è§‰', description: 'å¶å°”ä¼šçœ‹åˆ°ä¸å­˜åœ¨çš„å¹»è±¡' },
        { id: 7, name: 'ææ…Œç—‡', description: 'è·å¾—ææƒ§ç—‡ï¼Œç‰¹å®šåœºæ™¯è§¦å‘' },
        { id: 8, name: 'é€ƒé¿è¡Œä¸º', description: 'å›é¿ç‰¹å®šæƒ…å†µï¼Œå¦‚é»‘æš—ã€äººç¾¤ç­‰' },
        { id: 9, name: 'ææƒ§ç—‡', description: 'è·å¾—æ°¸ä¹…ææƒ§ç—‡' },
        { id: 10, name: 'èºç‹‚ç—‡', description: 'è·å¾—æ°¸ä¹…èºç‹‚ç—‡' }
    ];

    // ææƒ§ç—‡åˆ—è¡¨ï¼ˆ100ç§å¸¸è§ï¼‰
    const PHOBIAS = [
        'é»‘æš—ææƒ§ç—‡', 'é«˜å¤„ææƒ§ç—‡', 'å°é—­ç©ºé—´ææƒ§ç—‡', 'èœ˜è››ææƒ§ç—‡', 'è›‡ææƒ§ç—‡',
        'è¡€æ¶²ææƒ§ç—‡', 'æ­»äº¡ææƒ§ç—‡', 'äººç¾¤ææƒ§ç—‡', 'å­¤ç‹¬ææƒ§ç—‡', 'é»‘æš—ææƒ§ç—‡',
        'é—ªç”µææƒ§ç—‡', 'é›·å£°ææƒ§ç—‡', 'æ°´ææƒ§ç—‡', 'ç«ææƒ§ç—‡', 'åˆ€ææƒ§ç—‡',
        'æªæ¢°ææƒ§ç—‡', 'åŒ»ç”Ÿææƒ§ç—‡', 'åŒ»é™¢ææƒ§ç—‡', 'çŒ«ææƒ§ç—‡', 'ç‹—ææƒ§ç—‡',
        'è€é¼ ææƒ§ç—‡', 'æ˜†è™«ææƒ§ç—‡', 'é£è¡Œææƒ§ç—‡', 'é©¾é©¶ææƒ§ç—‡', 'æ¡¥æ¢ææƒ§ç—‡',
        'éš§é“ææƒ§ç—‡', 'ç”µæ¢¯ææƒ§ç—‡', 'é•œå­ææƒ§ç—‡', 'å½±å­ææƒ§ç—‡', 'é¬¼é­‚ææƒ§ç—‡',
        'æ€ªç‰©ææƒ§ç—‡', 'å¤–æ˜Ÿäººææƒ§ç—‡', 'å¤±è´¥ææƒ§ç—‡', 'æˆåŠŸææƒ§ç—‡', 'æ‰¿è¯ºææƒ§ç—‡',
        'äº²å¯†å…³ç³»ææƒ§ç—‡', 'ç¤¾äº¤ææƒ§ç—‡', 'å…¬å¼€æ¼”è®²ææƒ§ç—‡', 'è€ƒè¯•ææƒ§ç—‡', 'å·¥ä½œææƒ§ç—‡',
        'æƒå¨ææƒ§ç—‡', 'æ‰¹è¯„ææƒ§ç—‡', 'æ‹’ç»ææƒ§ç—‡', 'å°´å°¬ææƒ§ç—‡', 'å™ªéŸ³ææƒ§ç—‡',
        'å¯‚é™ææƒ§ç—‡', 'é¢œè‰²ææƒ§ç—‡', 'æ•°å­—ææƒ§ç—‡', 'åå­—æ¶ææƒ§ç—‡', 'å®—æ•™ææƒ§ç—‡',
        'é­”æ³•ææƒ§ç—‡', 'ç§‘å­¦ææƒ§ç—‡', 'æŠ€æœ¯è¿›æ­¥ææƒ§ç—‡', 'æœºå™¨äººææƒ§ç—‡', 'AIææƒ§ç—‡',
        'æ—¶é—´ææƒ§ç—‡', 'è¡°è€ææƒ§ç—‡', 'ç”Ÿç—…ææƒ§ç—‡', 'ç–¼ç—›ææƒ§ç—‡', 'å‘•åææƒ§ç—‡',
        'åå’½ææƒ§ç—‡', 'çª’æ¯ææƒ§ç—‡', 'æººæ°´ææƒ§ç—‡', 'ä¸­æ¯’ææƒ§ç—‡', 'è¾å°„ææƒ§ç—‡',
        'æ±¡æŸ“ææƒ§ç—‡', 'ç»†èŒææƒ§ç—‡', 'è‚®è„ææƒ§ç—‡', 'é™Œç”Ÿç¯å¢ƒææƒ§ç—‡', 'é™Œç”Ÿäººäººææƒ§ç—‡',
        'å¤–å›½äººææƒ§ç—‡', 'å¼‚æ€§ææƒ§ç—‡', 'åŒæ€§ææƒ§ç—‡', 'äº²å»ææƒ§ç—‡', 'æ‹¥æŠ±ææƒ§ç—‡',
        'èº«ä½“æ¥è§¦ææƒ§ç—‡', 'è£¸éœ²ææƒ§ç—‡', 'æ€§è¡Œä¸ºææƒ§ç—‡', 'æ€€å­•ææƒ§ç—‡', 'åˆ†å¨©ææƒ§ç—‡',
        'å©´å„¿ææƒ§ç—‡', 'å„¿ç«¥ææƒ§ç—‡', 'è€äººææƒ§ç—‡', 'å°¸ä½“ææƒ§ç—‡', 'å¢“åœ°ææƒ§ç—‡',
        'è‘¬ç¤¼ææƒ§ç—‡', 'å¹½çµææƒ§ç—‡', 'æ¶é­”ææƒ§ç—‡', 'å¤©ä½¿ææƒ§ç—‡', 'ç¥æ˜ææƒ§ç—‡',
        'è¯…å’’ææƒ§ç—‡', 'é¢„è¨€ææƒ§ç—‡', 'æ¢¦å¢ƒææƒ§ç—‡', 'å¤±çœ ææƒ§ç—‡', 'æ¸…é†’ææƒ§ç—‡',
        'é•œå­ææƒ§ç—‡', 'ç…§ç‰‡ææƒ§ç—‡', 'æ‘„åƒæœºææƒ§ç—‡', 'è¢«æ³¨è§†ææƒ§ç—‡', 'è¢«è·Ÿè¸ªææƒ§ç—‡',
        'è¢«ç›‘è§†ææƒ§ç—‡', 'è¢«å·å¬ææƒ§ç—‡', 'è¢«èƒŒå›ææƒ§ç—‡'
    ];

    // èºç‹‚ç—‡åˆ—è¡¨ï¼ˆ100ç§å¸¸è§ï¼‰
    const MANIAS = [
        'æ¸…æ´ç™–', 'æ•´ç†ç™–', 'å›¤ç§¯ç™–', 'å·çªƒç™–', 'è¯´è°ç™–',
        'è´­ç‰©ç™–', 'èµŒåšç™–', 'å·¥ä½œç‹‚', 'è¿åŠ¨ç‹‚', 'è¯»ä¹¦ç‹‚',
        'å†™ä½œç‹‚', 'ç»˜ç”»ç‹‚', 'éŸ³ä¹ç‹‚', 'èˆè¹ˆç‹‚', 'ç¾é£Ÿç‹‚',
        'é¥®é…’ç‹‚', 'å¸çƒŸç‹‚', 'è¯ç‰©ç‹‚', 'æ€§ç˜¾', 'è‡ªæ…°ç‹‚',
        'æš´éœ²ç™–', 'å·çª¥ç™–', 'ç”µè¯ç‹‚', 'çŸ­ä¿¡ç‹‚', 'ç½‘ç»œç‹‚',
        'æ¸¸æˆç‹‚', 'è‡ªæ‹ç‹‚', 'å‘å¸–ç‹‚', 'ç‚¹èµç‹‚', 'æ”¶è—ç™–',
        'è®°å½•ç™–', 'æ£€æŸ¥ç™–', 'é‡å¤ç™–', 'è®¡æ•°ç™–', 'ä»ªå¼ç™–',
        'æ´—æ‰‹ç‹‚', 'æ´—æ¾¡ç‹‚', 'åˆ·ç‰™ç‹‚', 'æ¢³å¤´ç‹‚', 'ç…§é•œç‹‚',
        'è‡ªè¨€è‡ªè¯­ç‹‚', 'å‚»ç¬‘ç‹‚', 'å“­æ³£ç‹‚', 'å°–å«ç‹‚', 'è·³è·ƒç‹‚',
        'æ—‹è½¬ç‹‚', 'æ‘‡æ™ƒç‹‚', 'ç‚¹å¤´ç‹‚', 'çœ¨çœ¼ç‹‚', 'æ¸…å–‰å’™ç‹‚',
        'å’¬æŒ‡ç”²ç‹‚', 'æ‹”æ¯›ç™–', 'çš®è‚¤æŠ æŒ–ç™–', 'ä¼¤å£èˆ”èˆç™–', 'å¼‚ç‰©æ’å…¥ç™–',
        'ç”œé£Ÿç‹‚', 'å’¸é£Ÿç‹‚', 'è¾£é£Ÿç‹‚', 'å†·é£Ÿç‹‚', 'çƒ­é£Ÿç‹‚',
        'å’–å•¡ç‹‚', 'èŒ¶ç‹‚', 'å¯ä¹ç‹‚', 'æ°´ç‹‚', 'å†°ç‹‚',
        'é˜³å…‰ç‹‚', 'æœˆå…‰ç‹‚', 'æ˜Ÿå…‰ç‹‚', 'ç¯å…‰ç‹‚', 'çƒ›å…‰ç‹‚',
        'çº¢è‰²ç‹‚', 'è“è‰²ç‹‚', 'ç»¿è‰²ç‹‚', 'é»„è‰²ç‹‚', 'ç´«è‰²ç‹‚',
        'åœ†å½¢ç‹‚', 'æ–¹å½¢ç‹‚', 'ä¸‰è§’å½¢ç‹‚', 'å¯¹ç§°ç‹‚', 'ä¸å¯¹ç§°ç‹‚',
        'æ•°å­—ç‹‚', 'å­—æ¯ç‹‚', 'è¯è¯­ç‹‚', 'åå­—ç‹‚', 'æ—¥æœŸç‹‚',
        'æ—¶é—´ç‹‚', 'æ–¹å‘ç‹‚', 'ä½ç½®ç‹‚', 'é¡ºåºç‹‚', 'åˆ†ç±»ç‹‚',
        'æ”¶è—ç‹‚', 'å±•ç¤ºç‹‚', 'èµ é€ç‹‚', 'äº¤æ¢ç‹‚', 'ä¹°å–ç‹‚'
    ];
    
    // ==================== å®Œæ•´çš„60ç§èŒä¸šæ•°æ®åº“ ====================
    
    const OCCUPATIONS = {
        // 2.1 å­¦æœ¯/çŸ¥è¯†å‹ (12ç§)
        'ä¼šè®¡å¸ˆ': {
            name: 'ä¼šè®¡å¸ˆ',
            pointFormula: 'EDU * 4',
            skills: ['ä¼šè®¡', 'æ³•å¾‹', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'è†å¬', 'è¯´æœ', 'ä¾¦æŸ¥', 'æ‰“å­—', 'æ¯è¯­'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'å¤è‘£å•†': {
            name: 'å¤è‘£å•†',
            pointFormula: 'EDU * 4',
            skills: ['ä¼°ä»·', 'è‰ºæœ¯/å·¥è‰º', 'å†å²', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'ä¾¦æŸ¥', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'å¤–è¯­1é¡¹'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'å»ºç­‘å¸ˆ': {
            name: 'å»ºç­‘å¸ˆ',
            pointFormula: 'EDU * 4',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'æ³•å¾‹', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'æœºæ¢°ç»´ä¿®', 'ä¾¦æŸ¥', 'ç§‘å­¦(æ•°å­¦)'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'è€ƒå¤å­¦å®¶': {
            name: 'è€ƒå¤å­¦å®¶',
            pointFormula: 'EDU * 4',
            skills: ['ä¼°ä»·', 'è€ƒå¤å­¦', 'å†å²', 'å¤–è¯­', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'æœºæ¢°ç»´ä¿®', 'ç§‘å­¦(åœ°è´¨)'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'åŒ–å­¦å®¶': {
            name: 'åŒ–å­¦å®¶',
            pointFormula: 'EDU * 4',
            skills: ['åŒ–å­¦', 'æ•™è‚²', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'åŒ»å­¦', 'ç‰©ç†', 'ä¾¦æŸ¥', 'ç§‘å­¦(è¯å­¦)'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'è®¾è®¡å¸ˆ': {
            name: 'è®¾è®¡å¸ˆ',
            pointFormula: 'EDU * 2 + APP * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'æœºæ¢°ç»´ä¿®', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'ä¾¦æŸ¥'],
            creditRating: 'å‡å¯',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'åŒ»ç”Ÿ': {
            name: 'åŒ»ç”Ÿ',
            pointFormula: 'EDU * 4',
            skills: ['æ€¥æ•‘', 'åŒ»å­¦', 'å¤–è¯­', 'å¿ƒç†', 'ç§‘å­¦(ç”Ÿç‰©)', 'ç§‘å­¦(è¯å­¦)', 'ä¿¡ç”¨è¯„çº§'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'å·¥ç¨‹å¸ˆ': {
            name: 'å·¥ç¨‹å¸ˆ',
            pointFormula: 'EDU * 4',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'ç”µæ°”ç»´ä¿®', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'æœºæ¢°ç»´ä¿®', 'æ“ä½œé‡å‹æœºæ¢°', 'ç§‘å­¦(ç‰©ç†)'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'è®°è€…': {
            name: 'è®°è€…',
            pointFormula: 'EDU * 4',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'å†å²', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'è†å¬', 'å¿ƒç†', 'å†™ä½œ', 'ç¤¾äº¤æŠ€èƒ½1é¡¹'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'å¾‹å¸ˆ': {
            name: 'å¾‹å¸ˆ',
            pointFormula: 'EDU * 4',
            skills: ['ä¼šè®¡', 'æ³•å¾‹', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'è¯´æœ', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'ä¾¦æŸ¥'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'å›¾ä¹¦é¦†å‘˜': {
            name: 'å›¾ä¹¦é¦†å‘˜',
            pointFormula: 'EDU * 4',
            skills: ['ä¼šè®¡', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'å¤–è¯­', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'å†å²', 'è®¡ç®—æœºä½¿ç”¨(ç°ä»£)'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },
        'æ•™æˆ': {
            name: 'æ•™æˆ',
            pointFormula: 'EDU * 4',
            skills: ['å›¾ä¹¦é¦†ä½¿ç”¨', 'å¤–è¯­', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'ä¾¦æŸ¥', 'æœ¬ä¸“ä¸šå­¦æœ¯æŠ€èƒ½2é¡¹'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'å­¦æœ¯å‹'
        },

        // 2.2 è¡ŒåŠ¨/æ‰§æ³•å‹ (12ç§)
        'è­¦å¯Ÿ': {
            name: 'è­¦å¯Ÿ',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['æ ¼æ–—', 'å°„å‡»', 'æå“', 'æ³•å¾‹', 'ä¾¦æŸ¥', 'æ½œè¡Œ', 'é©¾é©¶', 'å¿ƒç†', 'æ€¥æ•‘'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'è­¦æ¢': {
            name: 'è­¦æ¢',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'å°„å‡»', 'æå“', 'æ³•å¾‹', 'è†å¬', 'å¿ƒç†', 'ä¾¦æŸ¥', 'æ ¼æ–—'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'è”é‚¦æ¢å‘˜': {
            name: 'è”é‚¦æ¢å‘˜',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['å°„å‡»', 'æ³•å¾‹', 'è†å¬', 'è¯´æœ', 'å¿ƒç†', 'ä¾¦æŸ¥', 'æ ¼æ–—', 'æ½œè¡Œ'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'ç°ä»£',
            category: 'è¡ŒåŠ¨å‹'
        },
        'å†›äºº': {
            name: 'å†›äºº',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['å°„å‡»', 'æ ¼æ–—', 'çˆ†ç ´', 'èº²è—', 'æ½œè¡Œ', 'ç”Ÿå­˜', 'å¯¼èˆª', 'æ€¥æ•‘'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'å£«å…µ': {
            name: 'å£«å…µ',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['å°„å‡»', 'æ ¼æ–—', 'èº²è—', 'æœºæ¢°ç»´ä¿®', 'æ½œè¡Œ', 'ç”Ÿå­˜', 'è†å¬'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'å†›å®˜': {
            name: 'å†›å®˜',
            pointFormula: 'EDU * 2 + POW * 2',
            skills: ['ä¼šè®¡', 'å°„å‡»', 'å¯¼èˆª', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'ç”Ÿå­˜', 'æˆ˜æœ¯'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'ä¿é•–': {
            name: 'ä¿é•–',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['æ ¼æ–—', 'å°„å‡»', 'è†å¬', 'ä¾¦æŸ¥', 'æå“', 'æ€¥æ•‘', 'é©¾é©¶'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'çŒäºº': {
            name: 'çŒäºº',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['å°„å‡»', 'è†å¬', 'è‡ªç„¶', 'å¯¼èˆª', 'æ½œè¡Œ', 'è¿½è¸ª', 'ç”Ÿå­˜', 'æ ¼æ–—'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'ä¿å®‰': {
            name: 'ä¿å®‰',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['æ ¼æ–—', 'å°„å‡»', 'è†å¬', 'ä¾¦æŸ¥', 'æ³•å¾‹', 'æ€¥æ•‘', 'é©¾é©¶'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'ç§å®¶ä¾¦æ¢': {
            name: 'ç§å®¶ä¾¦æ¢',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['æ³•å¾‹', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'è†å¬', 'æ‘„å½±', 'å¿ƒç†', 'ä¾¦æŸ¥', 'ä¹”è£…', 'æ ¼æ–—'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },
        'æ³•åŒ»': {
            name: 'æ³•åŒ»',
            pointFormula: 'EDU * 4',
            skills: ['åŒ»å­¦', 'äººç±»å­¦', 'ç”Ÿç‰©', 'åŒ–å­¦', 'æ‘„å½±', 'ä¾¦æŸ¥', 'æ³•å¾‹'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'ç°ä»£',
            category: 'è¡ŒåŠ¨å‹'
        },
        'æ¶ˆé˜²å‘˜': {
            name: 'æ¶ˆé˜²å‘˜',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['æ”€çˆ¬', 'æ€¥æ•‘', 'è·³è·ƒ', 'æœºæ¢°ç»´ä¿®', 'é©¾é©¶', 'åŠ›é‡', 'æ ¼æ–—'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¡ŒåŠ¨å‹'
        },

        // 2.3 ç¤¾äº¤/è‰ºæœ¯å‹ (12ç§)
        'æ¼”å‘˜': {
            name: 'æ¼”å‘˜',
            pointFormula: 'EDU * 2 + APP * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'ä¹”è£…', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½3é¡¹', 'è†å¬'],
            creditRating: 'å‡å¯',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'è‰ºæœ¯å®¶': {
            name: 'è‰ºæœ¯å®¶',
            pointFormula: 'EDU * 2 + APP * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'å†å²', 'å¿ƒç†', 'ä¾¦æŸ¥', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'è‡ªç„¶'],
            creditRating: 'å‡å¯',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'ä½œå®¶': {
            name: 'ä½œå®¶',
            pointFormula: 'EDU * 4',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'å†å²', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'è‡ªç„¶', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½1é¡¹'],
            creditRating: 'å‡å¯',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'éŸ³ä¹å®¶': {
            name: 'éŸ³ä¹å®¶',
            pointFormula: 'EDU * 2 + APP * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º(ä¹å™¨)', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'è†å¬', 'ä¹”è£…'],
            creditRating: 'å‡å¯',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'æ‘„å½±å¸ˆ': {
            name: 'æ‘„å½±å¸ˆ',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º(æ‘„å½±)', 'åŒ–å­¦', 'ä¹”è£…', 'ä¾¦æŸ¥', 'æœºæ¢°ç»´ä¿®', 'å¿ƒç†'],
            creditRating: 'å‡å¯',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'ç¥èŒäººå‘˜': {
            name: 'ç¥èŒäººå‘˜',
            pointFormula: 'EDU * 2 + POW * 2',
            skills: ['ä¼šè®¡', 'å†å²', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'è†å¬', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'è¯´æœ'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'ç¤¾äº¤åæµ': {
            name: 'ç¤¾äº¤åæµ',
            pointFormula: 'EDU * 2 + APP * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'å†å²', 'éª‘æœ¯', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'å¤–è¯­'],
            creditRating: 'å‡å¯',
            era: '1920s',
            category: 'ç¤¾äº¤å‹'
        },
        'ç§˜ä¹¦': {
            name: 'ç§˜ä¹¦',
            pointFormula: 'EDU * 2 + APP * 2',
            skills: ['ä¼šè®¡', 'è‰ºæœ¯/å·¥è‰º', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'æ‰“å­—'],
            creditRating: 'å‡å¯',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'å¤–äº¤å®˜': {
            name: 'å¤–äº¤å®˜',
            pointFormula: 'EDU * 4',
            skills: ['å¤–è¯­2é¡¹', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'æ³•å¾‹', 'å†å²', 'è¯´æœ'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'é…’å§è€æ¿': {
            name: 'é…’å§è€æ¿',
            pointFormula: 'EDU * 2 + APP * 2',
            skills: ['ä¼šè®¡', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'å¿ƒç†', 'è†å¬', 'æ ¼æ–—', 'å°„å‡»'],
            creditRating: 'å‡å¯',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },
        'å¦“å¥³/ç”·å¦“': {
            name: 'å¦“å¥³/ç”·å¦“',
            pointFormula: 'EDU * 2 + APP * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'ä¹”è£…', 'å¿ƒç†', 'æ½œè¡Œ', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'è†å¬'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å‡å¯',
            category: 'ç¤¾äº¤å‹'
        },

        // 2.4 æŠ€æœ¯/å®ç”¨å‹ (12ç§)
        'é©¾é©¶å‘˜': {
            name: 'é©¾é©¶å‘˜',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['æ±½è½¦é©¾é©¶', 'æœºæ¢°ç»´ä¿®', 'å¯¼èˆª', 'å¿ƒç†', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'ç”µæ°”ç»´ä¿®'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'æœºæ¢°å¸ˆ': {
            name: 'æœºæ¢°å¸ˆ',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'ç”µæ°”ç»´ä¿®', 'æœºæ¢°ç»´ä¿®', 'é©¾é©¶', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'æ“ä½œé‡å‹æœºæ¢°'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'æŠ€å¸ˆ': {
            name: 'æŠ€å¸ˆ',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'ç”µæ°”ç»´ä¿®', 'æœºæ¢°ç»´ä¿®', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'ç§‘å­¦(ç‰©ç†)', 'æ“ä½œé‡å‹æœºæ¢°'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'ç”µå·¥': {
            name: 'ç”µå·¥',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['ç”µæ°”ç»´ä¿®', 'æœºæ¢°ç»´ä¿®', 'å›¾ä¹¦é¦†ä½¿ç”¨', 'ç§‘å­¦(ç‰©ç†)', 'æ”€çˆ¬'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'æœ¨åŒ ': {
            name: 'æœ¨åŒ ',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º(æœ¨å·¥)', 'æœºæ¢°ç»´ä¿®', 'æ”€çˆ¬', 'æ•°å­¦', 'é©¾é©¶'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'çŸ¿å·¥': {
            name: 'çŸ¿å·¥',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['æ”€çˆ¬', 'çˆ†ç ´', 'æœºæ¢°ç»´ä¿®', 'æ“ä½œé‡å‹æœºæ¢°', 'ç”Ÿå­˜', 'åœ°è´¨'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'æ°´æ‰‹': {
            name: 'æ°´æ‰‹',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['æœºæ¢°ç»´ä¿®', 'å¯¼èˆª', 'æ ¼æ–—', 'æ½œè¡Œ', 'æ¸¸æ³³', 'æŠ•æ·', 'é©¾é©¶(èˆ¹)'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'é£è¡Œå‘˜': {
            name: 'é£è¡Œå‘˜',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['æœºæ¢°ç»´ä¿®', 'å¯¼èˆª', 'é©¾é©¶(é£æœº)', 'ç”µå­', 'æ°”è±¡', 'æ— çº¿ç”µ'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'ç°ä»£',
            category: 'æŠ€æœ¯å‹'
        },
        'å†œå¤«': {
            name: 'å†œå¤«',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['å†œä¸š', 'è‰ºæœ¯/å·¥è‰º', 'æ±½è½¦é©¾é©¶', 'æœºæ¢°ç»´ä¿®', 'è‡ªç„¶', 'æ“ä½œé‡å‹æœºæ¢°', 'è¿½è¸ª'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'æ¸”æ°‘': {
            name: 'æ¸”æ°‘',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['è‡ªç„¶', 'å¯¼èˆª', 'æ¸¸æ³³', 'æ ¼æ–—', 'é©¾é©¶(èˆ¹)', 'ç”Ÿå­˜', 'æœºæ¢°ç»´ä¿®'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'æŠ€æœ¯å‹'
        },
        'å¿«é€’å‘˜': {
            name: 'å¿«é€’å‘˜',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['é©¾é©¶', 'æ½œè¡Œ', 'èº²è—', 'æœºæ¢°ç»´ä¿®', 'å¯¼èˆª', 'ç¤¾äº¤æŠ€èƒ½1é¡¹'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'ç°ä»£',
            category: 'æŠ€æœ¯å‹'
        },
        'ç”µè¯æ¥çº¿å‘˜': {
            name: 'ç”µè¯æ¥çº¿å‘˜',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['è†å¬', 'æ‰“å­—', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'å¿ƒç†', 'è®¡ç®—æœºä½¿ç”¨(ç°ä»£)'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'ç°ä»£',
            category: 'æŠ€æœ¯å‹'
        },

        // 2.5 åº•å±‚/è¾¹ç¼˜å‹ (6ç§)
        'æµæµªæ±‰': {
            name: 'æµæµªæ±‰',
            pointFormula: 'EDU * 2 + POW * 2',
            skills: ['èº²è—', 'è†å¬', 'å¿ƒç†', 'æ½œè¡Œ', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'ç”Ÿå­˜', 'æ”€çˆ¬'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¾¹ç¼˜å‹'
        },
        'ç›—è´¼': {
            name: 'ç›—è´¼',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['ä¼°ä»·', 'æ ¼æ–—', 'èº²è—', 'è†å¬', 'é”åŒ ', 'æ½œè¡Œ', 'å·çªƒ', 'æ”€çˆ¬'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¾¹ç¼˜å‹'
        },
        'èµŒå¾’': {
            name: 'èµŒå¾’',
            pointFormula: 'EDU * 2 + POW * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'è†å¬', 'å¿ƒç†', 'ä¾¦æŸ¥', 'ç¤¾äº¤æŠ€èƒ½2é¡¹', 'æ½œè¡Œ'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¾¹ç¼˜å‹'
        },
        'é»‘å¸®': {
            name: 'é»‘å¸®',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['æ ¼æ–—', 'å°„å‡»', 'æå“', 'è†å¬', 'å¿ƒç†', 'ä¾¦æŸ¥', 'é©¾é©¶', 'æ³•å¾‹'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¾¹ç¼˜å‹'
        },
        'èµ°ç§çŠ¯': {
            name: 'èµ°ç§çŠ¯',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['é©¾é©¶', 'æ½œè¡Œ', 'èº²è—', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'ä¾¦æŸ¥', 'æ ¼æ–—', 'å°„å‡»'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¾¹ç¼˜å‹'
        },
        'è¡—å¤´æ··æ··': {
            name: 'è¡—å¤´æ··æ··',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['æ ¼æ–—', 'èº²è—', 'è†å¬', 'æ½œè¡Œ', 'å·çªƒ', 'æ”€çˆ¬', 'è·³è·ƒ'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å‡å¯',
            category: 'è¾¹ç¼˜å‹'
        },

        // 2.6 ç‰¹æ®Š/å¤å¤å‹ (6ç§)
        'éƒ¨è½æˆå‘˜': {
            name: 'éƒ¨è½æˆå‘˜',
            pointFormula: 'EDU * 2 + POW * 2',
            skills: ['æ ¼æ–—', 'èº²è—', 'è†å¬', 'è‡ªç„¶', 'æ½œè¡Œ', 'ç”Ÿå­˜', 'è¿½è¸ª', 'æŠ•æ·'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å¤å¤',
            category: 'ç‰¹æ®Šå‹'
        },
        'è¨æ»¡': {
            name: 'è¨æ»¡',
            pointFormula: 'EDU * 2 + POW * 2',
            skills: ['äººç±»å­¦', 'è‡ªç„¶', 'å¿ƒç†', 'åŒ»å­¦(è‰è¯)', 'ç¤¾äº¤æŠ€èƒ½1é¡¹', 'ç¥ç§˜å­¦'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å¤å¤',
            category: 'ç‰¹æ®Šå‹'
        },
        'ç‰›ä»”': {
            name: 'ç‰›ä»”',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['æ ¼æ–—', 'å°„å‡»', 'éª‘æœ¯', 'è¿½è¸ª', 'ç”Ÿå­˜', 'è‡ªç„¶', 'æŠ•æ·'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å¤å¤',
            category: 'ç‰¹æ®Šå‹'
        },
        'æ¢é™©å®¶': {
            name: 'æ¢é™©å®¶',
            pointFormula: 'EDU * 2 + STR * 2',
            skills: ['æ”€çˆ¬', 'å¯¼èˆª', 'è‡ªç„¶', 'ç”Ÿå­˜', 'æ ¼æ–—', 'å°„å‡»', 'å¤–è¯­'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'å‡å¯',
            category: 'ç‰¹æ®Šå‹'
        },
        'ç‰¹æŠ€æ¼”å‘˜': {
            name: 'ç‰¹æŠ€æ¼”å‘˜',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['æ”€çˆ¬', 'è·³è·ƒ', 'æ½œè¡Œ', 'æ ¼æ–—', 'é©¾é©¶', 'éª‘æœ¯', 'æ¸¸æ³³'],
            creditRating: 'èŒä¸šæŠ€èƒ½',
            era: 'ç°ä»£',
            category: 'ç‰¹æ®Šå‹'
        },
        'é©¬æˆå›¢æ¼”å‘˜': {
            name: 'é©¬æˆå›¢æ¼”å‘˜',
            pointFormula: 'EDU * 2 + DEX * 2',
            skills: ['è‰ºæœ¯/å·¥è‰º', 'æ”€çˆ¬', 'è·³è·ƒ', 'ä¹”è£…', 'æ½œè¡Œ', 'ç¤¾äº¤æŠ€èƒ½1é¡¹'],
            creditRating: 'å…´è¶£æŠ€èƒ½',
            era: 'å‡å¯',
            category: 'ç‰¹æ®Šå‹'
        }
    };

    // ==================== èŒä¸šä¿¡ç”¨è¯„çº§èŒƒå›´ ====================
    const CREDIT_RATING_RANGES = {
        'ä¼šè®¡å¸ˆ': [30, 70], 'å¤è‘£å•†': [30, 60], 'å»ºç­‘å¸ˆ': [30, 70],
        'è€ƒå¤å­¦å®¶': [10, 40], 'åŒ–å­¦å®¶': [10, 40], 'è®¾è®¡å¸ˆ': [20, 50],
        'åŒ»ç”Ÿ': [30, 80], 'å·¥ç¨‹å¸ˆ': [30, 60], 'è®°è€…': [10, 30],
        'å¾‹å¸ˆ': [30, 80], 'å›¾ä¹¦é¦†å‘˜': [10, 35], 'æ•™æˆ': [20, 60],
        'è­¦å¯Ÿ': [9, 30], 'è­¦æ¢': [20, 50], 'è”é‚¦æ¢å‘˜': [20, 60],
        'å†›äºº': [8, 30], 'å£«å…µ': [5, 20], 'å†›å®˜': [20, 50],
        'ä¿é•–': [15, 40], 'çŒäºº': [10, 30], 'ä¿å®‰': [8, 20],
        'ç§å®¶ä¾¦æ¢': [20, 45], 'æ³•åŒ»': [20, 50], 'æ¶ˆé˜²å‘˜': [8, 20],
        'æ¼”å‘˜': [10, 40], 'è‰ºæœ¯å®¶': [5, 30], 'ä½œå®¶': [5, 30],
        'éŸ³ä¹å®¶': [5, 30], 'æ‘„å½±å¸ˆ': [10, 30], 'ç¥èŒäººå‘˜': [5, 30],
        'ç¤¾äº¤åæµ': [40, 80], 'ç§˜ä¹¦': [10, 30], 'å¤–äº¤å®˜': [30, 70],
        'é…’å§è€æ¿': [20, 40], 'å¦“å¥³/ç”·å¦“': [1, 20],
        'é©¾é©¶å‘˜': [10, 30], 'æœºæ¢°å¸ˆ': [10, 30], 'æŠ€å¸ˆ': [10, 30],
        'ç”µå·¥': [10, 30], 'æœ¨åŒ ': [10, 30], 'çŸ¿å·¥': [5, 20],
        'æ°´æ‰‹': [5, 20], 'é£è¡Œå‘˜': [20, 50], 'å†œå¤«': [5, 20],
        'æ¸”æ°‘': [5, 20], 'å¿«é€’å‘˜': [5, 20], 'ç”µè¯æ¥çº¿å‘˜': [5, 20],
        'æµæµªæ±‰': [0, 5], 'ç›—è´¼': [1, 20], 'èµŒå¾’': [1, 20],
        'é»‘å¸®': [5, 30], 'èµ°ç§çŠ¯': [5, 20], 'è¡—å¤´æ··æ··': [0, 5],
        'éƒ¨è½æˆå‘˜': [0, 5], 'è¨æ»¡': [0, 5], 'ç‰›ä»”': [5, 20],
        'æ¢é™©å®¶': [20, 50], 'ç‰¹æŠ€æ¼”å‘˜': [5, 20], 'é©¬æˆå›¢æ¼”å‘˜': [1, 15]
    };

    // æŠ€èƒ½åŸºç¡€å€¼è¡¨
    const SKILL_BASE_VALUES = {
        'ä¼šè®¡': 5, 'äººç±»å­¦': 1, 'ä¼°ä»·': 5, 'è€ƒå¤å­¦': 1, 'è‰ºæœ¯/å·¥è‰º': 5,
        'ä¹”è£…': 5, 'é©¾é©¶': 20, 'ç”µæ°”ç»´ä¿®': 10, 'æ ¼æ–—': 25, 'å°„å‡»': 20,
        'æ€¥æ•‘': 30, 'å†å²': 5, 'æå“': 15, 'è·³è·ƒ': 20, 'æ³•å¾‹': 5,
        'å›¾ä¹¦é¦†ä½¿ç”¨': 20, 'è†å¬': 20, 'é”åŒ ': 1, 'æœºæ¢°ç»´ä¿®': 10,
        'åŒ»å­¦': 1, 'è‡ªç„¶': 10, 'å¯¼èˆª': 10, 'ç¥ç§˜å­¦': 5, 'æ“ä½œé‡å‹æœºæ¢°': 1,
        'è¯´æœ': 10, 'å¿ƒç†': 10, 'æ‘„å½±': 5, 'ç‰©ç†': 1, 'æ½œè¡Œ': 20,
        'ç”Ÿå­˜': 10, 'æ¸¸æ³³': 20, 'æŠ•æ·': 20, 'è¿½è¸ª': 10, 'å†™ä½œ': 5,
        'ä¿¡ç”¨è¯„çº§': 0, 'æ¯è¯­': 50, 'å¤–è¯­': 1, 'éª‘æœ¯': 5, 'çˆ†ç ´': 1,
        'æ— çº¿ç”µ': 1, 'ç”µå­': 1, 'æ°”è±¡': 1, 'å†œä¸š': 1, 'æ‰“å­—': 20,
        'å·çªƒ': 10, 'èº²è—': 10, 'æ”€çˆ¬': 20, 'æˆ˜æœ¯': 1, 'åœ°è´¨': 1,
        'è¯å­¦': 1, 'åŒ–å­¦': 1, 'ç”Ÿç‰©': 1, 'æ•°å­¦': 1, 'å¤©æ–‡': 1
    };

    // ==================== å±æ€§ç”Ÿæˆå’Œå¹´é¾„ä¿®æ­£å‡½æ•° ====================

    // 3D6 Ã— 5
    function roll3d6x5() {
        const roll = Math.floor(Math.random() * 6) + 1 + 
                     Math.floor(Math.random() * 6) + 1 + 
                     Math.floor(Math.random() * 6) + 1;
        return roll * 5;
    }

    // (2D6+6) Ã— 5
    function roll2d6plus6x5() {
        const roll = Math.floor(Math.random() * 6) + 1 + 
                     Math.floor(Math.random() * 6) + 1 + 6;
        return roll * 5;
    }

    // ç”ŸæˆåŸºç¡€å±æ€§ï¼ˆéª°å­åŸå§‹å€¼ï¼‰
    function generateBaseAttributes() {
        return {
            baseSTR: roll3d6x5(),
            baseDEX: roll3d6x5(),
            baseCON: roll3d6x5(),
            baseAPP: roll3d6x5(),
            basePOW: roll3d6x5(),
            baseSIZ: roll2d6plus6x5(),
            baseINT: roll2d6plus6x5(),
            baseEDU: roll2d6plus6x5(),
            baseLUCK: roll3d6x5()
        };
    }

    // æ•™è‚²æˆé•¿åˆ¤å®šï¼š1D100 > å½“å‰EDU åˆ™ +1D10
    function applyEduGrowth(currentEdu) {
        const roll = Math.floor(Math.random() * 100) + 1;
        if (roll > currentEdu) {
            const growth = Math.floor(Math.random() * 10) + 1;
            return currentEdu + growth;
        }
        return currentEdu;
    }

    // æ ¹æ®å¹´é¾„åº”ç”¨å±æ€§ä¿®æ­£
    function applyAgeEffects(baseAttrs, age) {
        // å¤åˆ¶åŸºç¡€å€¼
        let result = {
            STR: baseAttrs.baseSTR,
            DEX: baseAttrs.baseDEX,
            CON: baseAttrs.baseCON,
            APP: baseAttrs.baseAPP,
            POW: baseAttrs.basePOW,
            SIZ: baseAttrs.baseSIZ,
            INT: baseAttrs.baseINT,
            EDU: baseAttrs.baseEDU,
            LUCK: baseAttrs.baseLUCK
        };
        
        // å¹´é¾„èŒƒå›´åˆ¤æ–­
        if (age >= 15 && age <= 19) {
            // STR+SIZåˆè®¡å‡5
            result.STR = Math.max(15, result.STR - 5);
            result.SIZ = Math.max(15, result.SIZ - 5);
            // EDUå‡5
            result.EDU = Math.max(0, result.EDU - 5);
            // å¹¸è¿å¯æŠ•ä¸¤æ¬¡å–é«˜ï¼ˆåœ¨åˆ›å»ºè§’è‰²æ—¶å·²å¤„ç†ï¼‰
            
        } else if (age >= 20 && age <= 39) {
            // EDUæˆé•¿åˆ¤å®šä¸€æ¬¡
            result.EDU = applyEduGrowth(result.EDU);
            
        } else if (age >= 40 && age <= 49) {
            // EDUæˆé•¿ä¸¤æ¬¡
            result.EDU = applyEduGrowth(result.EDU);
            result.EDU = applyEduGrowth(result.EDU);
            // STR+CON+DEXåˆè®¡å‡5
            result.STR = Math.max(15, result.STR - 5);
            result.CON = Math.max(15, result.CON - 5);
            result.DEX = Math.max(15, result.DEX - 5);
            // APPå‡5
            result.APP = Math.max(15, result.APP - 5);
            
        } else if (age >= 50 && age <= 59) {
            // EDUæˆé•¿ä¸‰æ¬¡
            for (let i = 0; i < 3; i++) {
                result.EDU = applyEduGrowth(result.EDU);
            }
            // STR+CON+DEXåˆè®¡å‡10
            result.STR = Math.max(15, result.STR - 10);
            result.CON = Math.max(15, result.CON - 10);
            result.DEX = Math.max(15, result.DEX - 10);
            // APPå‡10
            result.APP = Math.max(15, result.APP - 10);
            
        } else if (age >= 60 && age <= 69) {
            // EDUæˆé•¿å››æ¬¡
            for (let i = 0; i < 4; i++) {
                result.EDU = applyEduGrowth(result.EDU);
            }
            // STR+CON+DEXåˆè®¡å‡20
            result.STR = Math.max(15, result.STR - 20);
            result.CON = Math.max(15, result.CON - 20);
            result.DEX = Math.max(15, result.DEX - 20);
            // APPå‡15
            result.APP = Math.max(15, result.APP - 15);
            
        } else if (age >= 70 && age <= 79) {
            // EDUæˆé•¿å››æ¬¡
            for (let i = 0; i < 4; i++) {
                result.EDU = applyEduGrowth(result.EDU);
            }
            // STR+CON+DEXåˆè®¡å‡40
            result.STR = Math.max(15, result.STR - 40);
            result.CON = Math.max(15, result.CON - 40);
            result.DEX = Math.max(15, result.DEX - 40);
            // APPå‡20
            result.APP = Math.max(15, result.APP - 20);
            
        } else if (age >= 80 && age <= 89) {
            // EDUæˆé•¿å››æ¬¡
            for (let i = 0; i < 4; i++) {
                result.EDU = applyEduGrowth(result.EDU);
            }
            // STR+CON+DEXåˆè®¡å‡80
            result.STR = Math.max(15, result.STR - 80);
            result.CON = Math.max(15, result.CON - 80);
            result.DEX = Math.max(15, result.DEX - 80);
            // APPå‡25
            result.APP = Math.max(15, result.APP - 25);
        }
        
        return result;
    }

    // ==================== æŠ€èƒ½ç‚¹è®¡ç®— ====================

    function calculateOccupationPoints(occupationName, attributes) {
        const occupation = OCCUPATIONS[occupationName];
        if (!occupation) return 0;
        
        const { STR, DEX, CON, APP, POW, INT, SIZ, EDU } = attributes;
        
        let formula = occupation.pointFormula;
        formula = formula.replace(/STR/g, STR)
                         .replace(/DEX/g, DEX)
                         .replace(/CON/g, CON)
                         .replace(/APP/g, APP)
                         .replace(/POW/g, POW)
                         .replace(/INT/g, INT)
                         .replace(/SIZ/g, SIZ)
                         .replace(/EDU/g, EDU);
        
        try {
            const total = eval(formula);
            return Math.floor(total);
        } catch (e) {
            console.error('å…¬å¼è®¡ç®—é”™è¯¯:', formula);
            return 0;
        }
    }

    function calculateInterestPoints(intelligence) {
        return intelligence * 2;
    }

    function getSkillBaseValue(skillName) {
        if (skillName.includes('è‰ºæœ¯/å·¥è‰º')) return 5;
        if (skillName.includes('ç§‘å­¦(')) return 1;
        if (skillName.includes('å¤–è¯­')) return 1;
        
        if (SKILL_BASE_VALUES[skillName] !== undefined) {
            return SKILL_BASE_VALUES[skillName];
        }
        
        for (let key in SKILL_BASE_VALUES) {
            if (skillName.includes(key) || key.includes(skillName.split('(')[0])) {
                return SKILL_BASE_VALUES[key];
            }
        }
        
        return 5;
    }

    function getOccupationNames() {
        return Object.keys(OCCUPATIONS).sort();
    }

    // è·å–èŒä¸šçš„æŠ€èƒ½åˆ—è¡¨ï¼ˆå±•å¼€å ä½ç¬¦ï¼‰
    function getOccupationSkillList(occupationName) {
        const occupation = OCCUPATIONS[occupationName];
        if (!occupation) return [];
        
        let skillList = [];
        occupation.skills.forEach(skill => {
            if (skill.includes('ç¤¾äº¤æŠ€èƒ½')) {
                const match = skill.match(/ç¤¾äº¤æŠ€èƒ½(\d+)é¡¹/);
                const count = match ? parseInt(match[1]) : 1;
                for (let i = 0; i < count; i++) {
                    skillList.push('ç¤¾äº¤æŠ€èƒ½');
                }
            } else if (skill.includes('å¤–è¯­')) {
                const match = skill.match(/å¤–è¯­(\d+)é¡¹/);
                const count = match ? parseInt(match[1]) : 1;
                for (let i = 0; i < count; i++) {
                    skillList.push('å¤–è¯­');
                }
            } else if (skill.includes('ç§‘å­¦(')) {
                skillList.push(skill);
            } else if (skill.includes('è‰ºæœ¯/å·¥è‰º')) {
                if (skill.includes('(')) {
                    skillList.push(skill);
                } else {
                    skillList.push('è‰ºæœ¯/å·¥è‰º');
                }
            } else if (skill.includes('æœ¬ä¸“ä¸šå­¦æœ¯æŠ€èƒ½')) {
                const match = skill.match(/æœ¬ä¸“ä¸šå­¦æœ¯æŠ€èƒ½(\d+)é¡¹/);
                const count = match ? parseInt(match[1]) : 1;
                for (let i = 0; i < count; i++) {
                    skillList.push('å­¦æœ¯æŠ€èƒ½');
                }
            } else {
                skillList.push(skill);
            }
        });
        
        return skillList;
    }

    // æ¸²æŸ“æŠ€èƒ½é€‰é¡¹ï¼ˆæ”¯æŒèŒä¸šè¿‡æ»¤ï¼‰
    function renderSkillOptions(selectedSkill, type, occupationName) {
        let list = [];
        
        if (type === 'occupational') {
            const occupation = OCCUPATIONS[occupationName];
            if (occupation) {
                list = getOccupationSkillList(occupationName);
                list = list.map(skill => {
                    if (skill === 'ç¤¾äº¤æŠ€èƒ½') {
                        return SOCIAL_SKILLS;
                    } else if (skill === 'å¤–è¯­') {
                        return LANGUAGE_SKILLS;
                    } else if (skill === 'è‰ºæœ¯/å·¥è‰º') {
                        return CRAFT_SKILLS.map(s => `è‰ºæœ¯/å·¥è‰º(${s})`);
                    } else if (skill === 'å­¦æœ¯æŠ€èƒ½') {
                        return SCIENCE_SKILLS.map(s => `ç§‘å­¦(${s})`);
                    } else if (skill.includes('ç§‘å­¦(')) {
                        return [skill];
                    } else if (skill.includes('è‰ºæœ¯/å·¥è‰º(')) {
                        return [skill];
                    } else {
                        return skill;
                    }
                }).flat();
            } else {
                list = SKILLS_LIST.occupational;
            }
        } else if (type === 'interest') {
            list = SKILLS_LIST.interest;
        } else {
            list = SKILLS_LIST[type] || [];
        }
        
        list = [...new Set(list)].sort();
        
        return list.map(skill => 
            `<option value="${skill}" ${skill === selectedSkill ? 'selected' : ''}>${skill}</option>`
        ).join('');
    }
    
    // ==================== ç–¯ç‹‚ç³»ç»Ÿæ ¸å¿ƒå‡½æ•° ====================

    /**
     * ç†æ™ºæ£€å®šï¼ˆå¢å¼ºç‰ˆï¼Œå¸¦ç–¯ç‹‚åˆ¤å®šï¼‰
     */
    function enhancedSanCheck(characterName, lossFormula, source) {
        const char = data.get(characterName);
        if (!char) return null;
        
        const currentSan = char.stats.SAN || 50;
        const roll = rollD100();
        const result = judgeCOC(roll, currentSan);
        
        const [successLoss, failLoss] = lossFormula.split('/');
        let loss;
        if (result.text === 'æˆåŠŸ' || result.text === 'å›°éš¾æˆåŠŸ' || result.text === 'æéš¾æˆåŠŸ') {
            loss = parseDiceFormula(successLoss).total;
        } else {
            loss = parseDiceFormula(failLoss).total;
        }
        
        const newSan = Math.max(0, currentSan - loss);
        char.stats.SAN = newSan;
        
        // åˆå§‹åŒ–æ¡ä»¶å­—æ®µ
        if (!char.stats.conditions) char.stats.conditions = {};
        const conditions = char.stats.conditions;
        
        // ç–¯ç‹‚åˆ¤å®š
        let insanityResult = null;
        
        // 1. æ°¸ä¹…ç–¯ç‹‚
        if (newSan <= 0) {
            conditions.isPermanentlyInsane = true;
            insanityResult = {
                type: 'permanent',
                message: 'ğŸ’” è§’è‰²æ°¸ä¹…ç–¯ç‹‚ï¼'
            };
        }
        // 2. ä¸å®šæ€§ç–¯ç‹‚ï¼ˆä¸€å¤©å†…æŸå¤± â‰¥ å½“å‰SANçš„1/5ï¼‰
        else if (loss >= Math.floor(currentSan / 5)) {
            conditions.isIndefinitelyInsane = true;
            conditions.indefiniteStart = new Date().toISOString();
            insanityResult = {
                type: 'indefinite',
                message: 'ğŸ˜µ è§’è‰²é™·å…¥ä¸å®šæ€§ç–¯ç‹‚ï¼å°†æŒç»­æ•´ä¸ªæ¨¡ç»„'
            };
        }
        // 3. ä¸´æ—¶ç–¯ç‹‚ï¼ˆæŸå¤± â‰¥ 5ï¼‰
        else if (loss >= 5) {
            // éœ€è¦è¿›è¡Œæ™ºåŠ›æ£€å®š
            const int = char.stats.INT || 50;
            const intRoll = rollD100();
            const intResult = judgeCOC(intRoll, int);
            
            if (intResult.text === 'å¤±è´¥' || intResult.text === 'å¤§å¤±è´¥') {
                // æ™ºåŠ›æ£€å®šå¤±è´¥ â†’ é™·å…¥ä¸´æ—¶ç–¯ç‹‚
                const symptom = rollInstantInsanity();
                conditions.isTemporarilyInsane = true;
                conditions.insanitySymptom = symptom;
                conditions.insanityDuration = Math.floor(Math.random() * 10) + 1; // 1D10å°æ—¶
                conditions.insanityStart = new Date().toISOString();
                
                // è§¦å‘å³æ—¶ç—‡çŠ¶
                applyInsanitySymptom(characterName, symptom);
                
                insanityResult = {
                    type: 'temporary',
                    symptom: symptom,
                    duration: conditions.insanityDuration,
                    message: `ğŸ˜± è§’è‰²é™·å…¥ä¸´æ—¶ç–¯ç‹‚ï¼ç—‡çŠ¶ï¼š${symptom.name}ï¼ŒæŒç»­${conditions.insanityDuration}å°æ—¶`
                };
            } else {
                // æ™ºåŠ›æ£€å®šæˆåŠŸ â†’ ç†è§£å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä½†æ²¡ç–¯
                insanityResult = {
                    type: 'resisted',
                    message: 'ğŸ§  æ™ºåŠ›æ£€å®šæˆåŠŸï¼Œè§’è‰²ç†è§£äº†ææ€–ï¼Œé¿å…äº†ç–¯ç‹‚'
                };
            }
        }
        
        // 4. å¦‚æœå·²å¤„äºæ½œåœ¨ç–¯ç‹‚é˜¶æ®µï¼Œä¸”è¿™æ¬¡çœ‹åˆ°çš„æ˜¯ç–¯ç‹‚æ¥æº
        if (conditions.isInPotentialPhase && source === conditions.triggerSource) {
            // è§¦å‘ææƒ§ç—‡æ•ˆæœï¼šç›¸å…³æŠ€èƒ½è·å¾—ä¸€ä¸ªæƒ©ç½šéª°ï¼ˆè¿™é‡Œåªæ˜¯è®°å½•ï¼‰
            if (!conditions.activePhobias) conditions.activePhobias = [];
            conditions.activePhobias.push({
                source: source,
                triggeredAt: new Date().toISOString()
            });
        }
        
        // å…‹è‹é²ç¥è¯æŠ€èƒ½æˆé•¿ï¼ˆå¦‚æœæ˜¯å…‹è‹é²ç›¸å…³äº‹ä»¶ï¼‰
        if (source === 'mythos') {
            if (!char.stats.cthulhuMythos) char.stats.cthulhuMythos = 0;
            if (insanityResult && insanityResult.type !== 'resisted') {
                // ç¬¬ä¸€æ¬¡ç–¯ç‹‚ +5ï¼Œä¹‹åæ¯æ¬¡ +1
                if (char.stats.cthulhuMythos === 0) {
                    char.stats.cthulhuMythos += 5;
                } else {
                    char.stats.cthulhuMythos += 1;
                }
            }
        }
        
        data.save();
        
        return {
            roll,
            result,
            loss,
            newSan,
            insanity: insanityResult,
            cthulhuMythos: char.stats.cthulhuMythos
        };
    }

    /**
     * éšæœºå³æ—¶ç–¯ç‹‚ç—‡çŠ¶
     */
    function rollInstantInsanity() {
        const roll = Math.floor(Math.random() * INSANITY_INSTANT_SYMPTOMS.length);
        return INSANITY_INSTANT_SYMPTOMS[roll];
    }

    /**
     * éšæœºæ€»ç»“ç–¯ç‹‚ç—‡çŠ¶
     */
    function rollSummaryInsanity() {
        const roll = Math.floor(Math.random() * INSANITY_SUMMARY_SYMPTOMS.length);
        return INSANITY_SUMMARY_SYMPTOMS[roll];
    }

    /**
     * éšæœºææƒ§ç—‡
     */
    function rollRandomPhobia() {
        const roll = Math.floor(Math.random() * PHOBIAS.length);
        return PHOBIAS[roll];
    }

    /**
     * éšæœºèºç‹‚ç—‡
     */
    function rollRandomMania() {
        const roll = Math.floor(Math.random() * MANIAS.length);
        return MANIAS[roll];
    }

    /**
     * åº”ç”¨ç–¯ç‹‚ç—‡çŠ¶
     */
    function applyInsanitySymptom(characterName, symptom) {
        const char = data.get(characterName);
        if (!char) return;
        
        if (!char.stats.conditions.insanityHistory) {
            char.stats.conditions.insanityHistory = [];
        }
        
        char.stats.conditions.insanityHistory.push({
            symptom: symptom,
            timestamp: new Date().toISOString()
        });
        
        data.save();
    }

    /**
     * ä¸´æ—¶ç–¯ç‹‚ç»“æŸï¼Œè¿›å…¥æ½œåœ¨ç–¯ç‹‚é˜¶æ®µ
     */
    function endTemporaryInsanity(characterName) {
        const char = data.get(characterName);
        if (!char || !char.stats.conditions.isTemporarilyInsane) return;
        
        char.stats.conditions.isTemporarilyInsane = false;
        char.stats.conditions.isInPotentialPhase = true;
        
        // éšæœºä¸€ä¸ªæ€»ç»“ç—‡çŠ¶ï¼ˆå¯é€‰ï¼‰
        const summarySymptom = rollSummaryInsanity();
        if (!char.stats.conditions.summarySymptoms) {
            char.stats.conditions.summarySymptoms = [];
        }
        char.stats.conditions.summarySymptoms.push(summarySymptom);
        
        data.save();
        
        return {
            message: `ğŸ§  ä¸´æ—¶ç–¯ç‹‚ç»“æŸï¼Œè¿›å…¥æ½œåœ¨ç–¯ç‹‚é˜¶æ®µã€‚æ€»ç»“ç—‡çŠ¶ï¼š${summarySymptom.name}`,
            symptom: summarySymptom
        };
    }

    /**
     * ç°å®è®¤çŸ¥æ£€å®š
     */
    function realityCheck(characterName) {
        const char = data.get(characterName);
        if (!char) return null;
        
        const currentSan = char.stats.SAN || 50;
        const roll = rollD100();
        const result = judgeCOC(roll, currentSan);
        
        if (result.text !== 'å¤±è´¥' && result.text !== 'å¤§å¤±è´¥') {
            // æˆåŠŸçœ‹ç©¿å¹»è§‰
            return {
                success: true,
                roll,
                result,
                message: 'ğŸ‘ï¸ ä½ æ„è¯†åˆ°è¿™æ˜¯å¹»è§‰ï¼'
            };
        } else {
            // å¤±è´¥ï¼ŒæŸå¤±1SAN
            const newSan = Math.max(0, currentSan - 1);
            char.stats.SAN = newSan;
            data.save();
            return {
                success: false,
                roll,
                result,
                newSan,
                message: 'ğŸ˜µ ä½ æ— æ³•çœ‹ç©¿å¹»è§‰ï¼ŒæŸå¤±1ç‚¹ç†æ™º'
            };
        }
    }

    /**
     * ç–¯ç‹‚æ²»ç–—
     */
    function treatInsanity(characterName, treatmentType) {
        const char = data.get(characterName);
        if (!char) return null;
        
        const currentSan = char.stats.SAN || 50;
        const maxSan = calculateMaxSAN(char.stats);
        const roll = rollD100();
        
        let sanGain = 0;
        let success = false;
        let message = '';
        
        switch(treatmentType) {
            case 'private':
                // ç§äººæŠ¤ç†ï¼š01-95æˆåŠŸæ¢å¤3SANï¼Œæ¥ç€ç†æ™ºæ£€å®šæˆåŠŸåˆ™æ²»æ„ˆ
                if (roll <= 95) {
                    sanGain = 3;
                    success = true;
                    message = 'âœ… ç§äººæŠ¤ç†æˆåŠŸï¼Œæ¢å¤3ç‚¹ç†æ™º';
                    
                    // ç†æ™ºæ£€å®šå†³å®šæ˜¯å¦æ²»æ„ˆ
                    const sanRoll = rollD100();
                    const sanResult = judgeCOC(sanRoll, currentSan + sanGain);
                    if (sanResult.text !== 'å¤±è´¥' && sanResult.text !== 'å¤§å¤±è´¥') {
                        char.stats.conditions.isIndefinitelyInsane = false;
                        message += 'ï¼Œç–¯ç‹‚ç—‡çŠ¶æ²»æ„ˆï¼';
                    }
                } else {
                    message = 'âŒ ç§äººæŠ¤ç†æ— æ•ˆ';
                }
                break;
                
            case 'asylum':
                // æ”¶å®¹æ‰€ï¼š01-50æ¢å¤3SANï¼Œ51-95æ— æ•ˆï¼Œ96-100æ¶åŒ–
                if (roll <= 50) {
                    sanGain = 3;
                    success = true;
                    message = 'âœ… æ”¶å®¹æ‰€æ²»ç–—æˆåŠŸï¼Œæ¢å¤3ç‚¹ç†æ™º';
                } else if (roll <= 95) {
                    message = 'âŒ æ”¶å®¹æ‰€æ²»ç–—æ— æ•ˆ';
                } else {
                    sanGain = -1;
                    message = 'ğŸ’” æ”¶å®¹æ‰€æ²»ç–—æ¶åŒ–ï¼ŒæŸå¤±1ç‚¹ç†æ™º';
                }
                break;
                
            case 'self':
                // è‡ªæ•‘ï¼šæ ¹æ®è§’è‰²èƒŒæ™¯æ¡ç›®è¿›è¡Œç†æ™ºæ£€å®š
                // è¿™é‡Œç®€åŒ–ä¸º1D6æ¢å¤ï¼Œå¤±è´¥åˆ™æŸå¤±1
                if (roll <= 50) { // å‡è®¾50%æˆåŠŸç‡
                    sanGain = Math.floor(Math.random() * 6) + 1;
                    success = true;
                    message = `âœ… è‡ªæ•‘æˆåŠŸï¼Œæ¢å¤${sanGain}ç‚¹ç†æ™º`;
                } else {
                    sanGain = -1;
                    message = 'âŒ è‡ªæ•‘å¤±è´¥ï¼ŒæŸå¤±1ç‚¹ç†æ™º';
                }
                break;
        }
        
        const newSan = Math.max(0, Math.min(maxSan, currentSan + sanGain));
        char.stats.SAN = newSan;
        data.save();
        
        return {
            success,
            sanGain,
            newSan,
            message
        };
    }

    /**
     * æ£€æŸ¥æ½œåœ¨ç–¯ç‹‚é˜¶æ®µé¢å¯¹ææƒ§æºçš„æ•ˆæœ
     */
    function applyPhobiaPenalty(characterName, skillRoll, skillName) {
        const char = data.get(characterName);
        if (!char || !char.stats.conditions.isInPotentialPhase) return skillRoll;
        
        // å¦‚æœæŠ€èƒ½åä¸ææƒ§ç—‡ç›¸å…³ï¼Œè¿”å›å¸¦æƒ©ç½šéª°çš„ç»“æœ
        // è¿™é‡Œç®€åŒ–ä¸ºè¿”å›åŸå€¼ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦åœ¨æ£€å®šå‡½æ•°ä¸­å¤„ç†
        return skillRoll;
    }
    
    // ==================== å¤´åƒä¸Šä¼ å¤„ç† ====================
    
    function handleAvatarUpload(file, callback) {
        const reader = new FileReader();
        reader.onload = (e) => {
            callback(e.target.result);
        };
        reader.readAsDataURL(file);
    }
    
    // æ¸²æŸ“å¤´åƒ
    function renderAvatar(avatarData, name) {
        if (avatarData) {
            return `<img src="${avatarData}" alt="${name}" style="width:100%; height:100%; object-fit:cover;">`;
        }
        return `<div style="font-size: 40px; color: var(--coc-text-muted);">ğŸ¦Œ</div>`;
    }
    
    // æ¸²æŸ“è§’è‰²å¡ç‰‡
    function renderCharacterCard(name, stats) {
        try {
            stats = stats || {};
            
            const maxHP = calculateMaxHP(stats);
            const currentHP = stats.HP || maxHP;
            const hpPercent = Math.min(100, Math.max(0, (currentHP / maxHP) * 100));
            
            const maxSAN = calculateMaxSAN(stats);
            const currentSAN = stats.SAN || maxSAN;
            const sanPercent = Math.min(100, Math.max(0, (currentSAN / maxSAN) * 100));
            
            const move = calculateMove(stats);
            const build = calculateBuild(stats.STR, stats.SIZ);
            const db = calculateDB(stats.STR, stats.SIZ);
            const armor = stats.armor || 0;
            
            const occupation = stats.occupation || 'è°ƒæŸ¥å‘˜';
            const gender = stats.gender || 'â€”';
            const birthYear = stats.birthYear || 'â€”';
            const currentYear = stats.currentYear || 'â€”';
            const age = (currentYear && birthYear && currentYear !== 'â€”' && birthYear !== 'â€”') ? currentYear - birthYear : 'â€”';
            const birthplace = stats.birthplace || 'â€”';
            const residence = stats.residence || 'â€”';
            
            const occupationalSkills = stats.occupationalSkills || {};
            const interestSkills = stats.interestSkills || {};
            const fightingSkills = stats.fightingSkills || {};
            const possessions = stats.possessions || [];
            const assets = stats.assets || { spendingLevel: 'â€”', cash: 'â€”', assets: 'â€”' };
            const relationships = stats.relationships || [];
            const insanity = stats.insanity || [];

            return `
                <div class="coc-card">
                    <div>
                        <div class="coc-profile">
                            <div class="coc-avatar" style="overflow:hidden;">
                                ${renderAvatar(stats.avatar, name)}
                            </div>
                            <div>
                                <div class="coc-name">${name}</div>
                                <div class="coc-subtitle">${occupation} Â· ${gender} Â· ${age}å²</div>
                            </div>
                        </div>
                        <div class="coc-info-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div><span class="coc-info-label">å‡ºç”Ÿå¹´ä»½ï¼š</span> ${birthYear}</div>
                            <div><span class="coc-info-label">å½“å‰å¹´ä»½ï¼š</span> ${currentYear}</div>
                            <div><span class="coc-info-label">å‡ºç”Ÿåœ°ï¼š</span> ${birthplace}</div>
                            <div><span class="coc-info-label">å±…ä½åœ°ï¼š</span> ${residence}</div>
                        </div>
                    </div>

                    <div class="coc-bar-container">
                        <div class="coc-bar-item">
                            <div class="coc-bar-header">
                                <span>â¤ï¸ HP</span>
                                <span>${currentHP}/${maxHP}</span>
                            </div>
                            <div class="coc-bar-bg">
                                <div class="coc-bar-fill hp" style="width: ${hpPercent}%;"></div>
                            </div>
                        </div>
                        <div class="coc-bar-item">
                            <div class="coc-bar-header">
                                <span>ğŸ§  SAN</span>
                                <span>${currentSAN}/${maxSAN}</span>
                            </div>
                            <div class="coc-bar-bg">
                                <div class="coc-bar-fill san" style="width: ${sanPercent}%;"></div>
                            </div>
                        </div>
                        <div class="coc-bar-item" style="text-align: center;">
                            <div class="coc-bar-header" style="justify-content: center;">MOV</div>
                            <div style="font-size: 16px; font-weight: 700;">${move}</div>
                        </div>
                    </div>

                    <div>
                        <div class="coc-section-title">ğŸ“Š å±æ€§</div>
                        <div class="coc-stats-grid">
                            ${['STR', 'CON', 'SIZ', 'DEX', 'APP', 'INT', 'POW', 'EDU', 'LUCK'].map(attr => `
                                <div class="coc-stat-item">
                                    <div class="coc-stat-label">${attr}</div>
                                    <div class="coc-stat-value">${stats[attr] || 'â€”'}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="coc-stat-row">
                            <div class="coc-stat-row-item">ä½“æ ¼ ${build} Â· ä¼¤å®³åŠ å€¼ ${db} Â· æŠ¤ç”² ${armor}</div>
                        </div>
                        <div class="coc-stat-row">
                            <div class="coc-stat-row-item">âš¡ é—ªé¿: ${Math.floor(stats.DEX / 2)}%</div>
                        </div>
                    </div>

                    <div>
                        <div class="coc-section-title">ğŸ” èŒä¸šæŠ€èƒ½</div>
                        <div class="coc-skills-grid">
                            ${Object.keys(occupationalSkills).length > 0 
                                ? Object.entries(occupationalSkills).map(([skill, value]) => `
                                    <div class="coc-skill-item">
                                        <span class="coc-skill-name">${skill}</span>
                                        <span class="coc-skill-value occupational">${value}%</span>
                                    </div>
                                `).join('')
                                : '<div class="coc-skill-item"><span class="coc-skill-name">æ— èŒä¸šæŠ€èƒ½</span></div>'
                            }
                        </div>
                    </div>

                    <div>
                        <div class="coc-section-title">âœ¨ å…´è¶£æŠ€èƒ½</div>
                        <div class="coc-skills-grid">
                            ${Object.keys(interestSkills).length > 0
                                ? Object.entries(interestSkills).map(([skill, value]) => `
                                    <div class="coc-skill-item">
                                        <span class="coc-skill-name">${skill}</span>
                                        <span class="coc-skill-value interest">${value}%</span>
                                    </div>
                                `).join('')
                                : '<div class="coc-skill-item"><span class="coc-skill-name">æ— å…´è¶£æŠ€èƒ½</span></div>'
                            }
                        </div>
                    </div>

                    <div>
                        <div class="coc-section-title">âš”ï¸ æ ¼æ–—æŠ€èƒ½</div>
                        <div class="coc-skills-grid">
                            ${Object.keys(fightingSkills).length > 0
                                ? Object.entries(fightingSkills).map(([skill, value]) => `
                                    <div class="coc-skill-item">
                                        <span class="coc-skill-name">${skill}</span>
                                        <span class="coc-skill-value fighting">${value}%</span>
                                    </div>
                                `).join('')
                                : '<div class="coc-skill-item"><span class="coc-skill-name">æ— æ ¼æ–—æŠ€èƒ½</span></div>'
                            }
                        </div>
                    </div>

                    <div>
                        <div class="coc-section-title">ğŸ“œ èƒŒæ™¯æ•…äº‹</div>
                        <div class="coc-backstory">${stats.backstory || 'â€”â€”'}</div>
                    </div>

                    <div>
                        <div class="coc-section-title">ğŸ’ è£…å¤‡ç‰©å“</div>
                        <div class="coc-weapons-list">
                            ${possessions.length > 0 
                                ? possessions.map(item => `
                                    <div class="coc-possession-row">
                                        <span>${item.name}</span>
                                        <span>${item.quantity || 1}x</span>
                                    </div>
                                `).join('') 
                                : '<div style="color: #8e7c68; text-align: center; padding: 8px;">æ— </div>'}
                        </div>
                    </div>

                    <div>
                        <div class="coc-section-title">ğŸ’° èµ„äº§</div>
                        <div class="coc-assets-grid">
                            <div class="coc-asset-item">
                                <div class="coc-asset-label">æ¶ˆè´¹æ°´å¹³</div>
                                <div class="coc-asset-value">${assets.spendingLevel}</div>
                            </div>
                            <div class="coc-asset-item">
                                <div class="coc-asset-label">ç°é‡‘</div>
                                <div class="coc-asset-value">${assets.cash}</div>
                            </div>
                            <div class="coc-asset-item">
                                <div class="coc-asset-label">èµ„äº§</div>
                                <div class="coc-asset-value">${assets.assets}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="coc-section-title">ğŸ§  ç–¯ç‹‚ç—‡çŠ¶</div>
                        <div class="coc-weapons-list">
                            ${insanity.length > 0 
                                ? insanity.map(item => `
                                    <div class="coc-relationship-row">
                                        <span>${item.type}</span>
                                        <span>${item.description}</span>
                                    </div>
                                `).join('') 
                                : '<div style="color: #8e7c68; text-align: center; padding: 8px;">æ— </div>'}
                        </div>
                    </div>

                    <div>
                        <div class="coc-section-title">ğŸ¤ åŒä¼´å…³ç³»</div>
                        <div class="coc-weapons-list">
                            ${relationships.length > 0 
                                ? relationships.map(rel => `
                                    <div class="coc-relationship-row">
                                        <span>${rel.name}</span>
                                        <span>${rel.relationship}</span>
                                    </div>
                                `).join('') 
                                : '<div style="color: #8e7c68; text-align: center; padding: 8px;">æ— </div>'}
                        </div>
                    </div>

                    <button class="coc-btn edit" id="coc-edit-mode-btn">âœï¸ ç¼–è¾‘è§’è‰²</button>
                </div>
            `;
        } catch (e) {
            console.error('[COC] æ¸²æŸ“å¡ç‰‡å‡ºé”™:', e);
            return `
                <div class="coc-card" style="padding:20px;">
                    <div style="color:red; margin-bottom:10px;">âŒ æ¸²æŸ“é”™è¯¯: ${e.message}</div>
                    <div style="margin-bottom:10px;">è§’è‰²å: ${name}</div>
                    <button class="coc-btn edit" id="coc-edit-mode-btn">âœï¸ ç¼–è¾‘è§’è‰²</button>
                </div>
            `;
        }
    }
    
    // æ¸²æŸ“æŸ¥çœ‹æ¨¡å¼
    function renderViewMode() {
        const characters = data.getAll();
        const names = Object.keys(characters).sort();
        const select = document.getElementById('coc-role-select');
        
        if (select) {
            let options = '<option value="">é€‰æ‹©è§’è‰²</option>';
            options += names.map(name => `<option value="${name}">${name}</option>`).join('');
            options += `<option value="__NEW__" class="coc-add-role-option">â• æ–°å¢è§’è‰²...</option>`;
            select.innerHTML = options;
        }
        
        const display = document.getElementById('coc-stats-display');
        if (display) {
            display.innerHTML = '<div class="coc-empty">ğŸ‘† è¯·é€‰æ‹©è§’è‰²</div>';
        }
    }
    
    // ç»‘å®šå·¥å…·æ äº‹ä»¶
    function bindToolbarEvents() {
        const select = document.getElementById('coc-role-select');
        if (select) {
            select.addEventListener('change', (e) => {
                const value = e.target.value;
                
                if (value === '__NEW__') {
                    // ç”ŸæˆåŸºç¡€å±æ€§
                    const baseAttrs = generateBaseAttributes();
                    
                    // é»˜è®¤å¹´é¾„30å²ï¼ˆ20-39åŒºé—´ï¼‰
                    const defaultAge = 30;
                    
                    // åº”ç”¨å¹´é¾„ä¿®æ­£
                    const finalAttrs = applyAgeEffects(baseAttrs, defaultAge);
                    
                    const newName = prompt('è¯·è¾“å…¥æ–°è§’è‰²å:');
                    if (newName && newName.trim()) {
                        const name = newName.trim();
                        if (data.get(name)) {
                            alert('âŒ è§’è‰²å·²å­˜åœ¨');
                        } else {
                            const defaultStats = {
                                occupation: 'è°ƒæŸ¥å‘˜',
                                gender: 'ç”·',
                                birthYear: 1895, // å‡è®¾å½“å‰1925å¹´ï¼Œ30å²åˆ™1895å¹´å‡ºç”Ÿ
                                currentYear: 1925,
                                birthplace: '',
                                residence: '',
                                // ä¿å­˜åŸºç¡€å±æ€§ç”¨äºåç»­å¹´é¾„è°ƒæ•´
                                baseSTR: baseAttrs.baseSTR,
                                baseDEX: baseAttrs.baseDEX,
                                baseCON: baseAttrs.baseCON,
                                baseAPP: baseAttrs.baseAPP,
                                basePOW: baseAttrs.basePOW,
                                baseSIZ: baseAttrs.baseSIZ,
                                baseINT: baseAttrs.baseINT,
                                baseEDU: baseAttrs.baseEDU,
                                baseLUCK: baseAttrs.baseLUCK,
                                // å½“å‰å®é™…å±æ€§ï¼ˆå·²åº”ç”¨å¹´é¾„ä¿®æ­£ï¼‰
                                ...finalAttrs,
                                HP: Math.floor((finalAttrs.CON + finalAttrs.SIZ) / 10),
                                SAN: finalAttrs.POW,
                                occupationalSkills: {},
                                interestSkills: {},
                                fightingSkills: {},
                                possessions: [],
                                assets: { spendingLevel: '', cash: '', assets: '' },
                                relationships: [],
                                insanity: []
                            };
                            data.set(name, defaultStats);
                            renderViewMode();
                            
                            setTimeout(() => {
                                select.value = name;
                                select.dispatchEvent(new Event('change'));
                            }, 100);
                        }
                    } else {
                        select.value = '';
                    }
                    return;
                }
                
                if (!value) {
                    const display = document.getElementById('coc-stats-display');
                    if (display) {
                        display.innerHTML = '<div class="coc-empty">ğŸ‘† è¯·é€‰æ‹©è§’è‰²</div>';
                    }
                    return;
                }
                
                const char = data.get(value);
                if (char) {
                    try {
                        const cardHtml = renderCharacterCard(value, char.stats);
                        const display = document.getElementById('coc-stats-display');
                        if (display) {
                            display.innerHTML = cardHtml;
                            
                            setTimeout(() => {
                                const editBtn = document.getElementById('coc-edit-mode-btn');
                                if (editBtn) {
                                    editBtn.onclick = () => {
                                        enterEditMode(value, char.stats);
                                    };
                                } else {
                                    console.error('[COC] ç¼–è¾‘æŒ‰é’®æœªæ‰¾åˆ°');
                                }
                            }, 50);
                        }
                    } catch (e) {
                        console.error('[COC] æ˜¾ç¤ºå¡ç‰‡å‡ºé”™:', e);
                        const display = document.getElementById('coc-stats-display');
                        if (display) {
                            display.innerHTML = `<div style="color:red; padding:20px;">âŒ æ˜¾ç¤ºé”™è¯¯: ${e.message}</div>`;
                        }
                    }
                } else {
                    const display = document.getElementById('coc-stats-display');
                    if (display) {
                        display.innerHTML = '<div class="coc-empty">ğŸ‘† è§’è‰²æ•°æ®ä¸ºç©º</div>';
                    }
                }
            });
        }
        
        const importBtn = document.getElementById('coc-import-btn');
        if (importBtn) importBtn.onclick = () => importFromFile();
        
        const exportBtn = document.getElementById('coc-export-btn');
        if (exportBtn) exportBtn.onclick = () => exportCharacter();
        
        const deleteBtn = document.getElementById('coc-delete-btn');
        if (deleteBtn) deleteBtn.onclick = () => deleteCharacter();
    }
    
    // è¿›å…¥ç¼–è¾‘æ¨¡å¼
    function enterEditMode(name, stats) {
        isEditing = true;
        currentEditName = name;
        currentEditStats = JSON.parse(JSON.stringify(stats));
        
        const display = document.getElementById('coc-stats-display');
        if (display) display.style.display = 'none';
        
        const editSection = document.getElementById('coc-edit-section');
        if (editSection) {
            editSection.style.display = 'block';
            editSection.innerHTML = renderEditForm(name, currentEditStats);
        }
        
        bindEditEvents();
    }
    
    // æ¸²æŸ“æŠ€èƒ½é€‰é¡¹ï¼ˆå·²æœ‰ï¼Œä½†ä¸Šé¢å·²å®šä¹‰ï¼‰
    
    // æ¸²æŸ“æ­¦å™¨é€‰é¡¹
    function renderWeaponOptions(selectedWeapon) {
        return WEAPONS_LIST.map(weapon => 
            `<option value="${weapon.name}" ${weapon.name === selectedWeapon ? 'selected' : ''} data-skill="${weapon.skill}" data-damage="${weapon.damage}">${weapon.name}</option>`
        ).join('');
    }
    
    // æ¸²æŸ“ç¼–è¾‘è¡¨å•
    function renderEditForm(name, stats) {
        const occupationNames = getOccupationNames();
        const currentOccupation = stats.occupation || 'è°ƒæŸ¥å‘˜';
        
        // è®¡ç®—å½“å‰å±æ€§å€¼
        const attributes = {
            STR: stats.STR || 50,
            DEX: stats.DEX || 50,
            CON: stats.CON || 50,
            APP: stats.APP || 50,
            POW: stats.POW || 50,
            INT: stats.INT || 50,
            SIZ: stats.SIZ || 50,
            EDU: stats.EDU || 50
        };
        
        // è®¡ç®—æŠ€èƒ½ç‚¹
        const occPoints = calculateOccupationPoints(currentOccupation, attributes);
        const intPoints = calculateInterestPoints(attributes.INT);
        
        return `
            <div class="coc-edit-section">
                <div class="coc-edit-title">âœï¸ ç¼–è¾‘ ${name}</div>
                
                <!-- å¤´åƒä¸Šä¼ åŒº -->
                <div class="coc-edit-avatar">
                    <div class="coc-edit-avatar-preview" id="coc-avatar-preview">
                        ${stats.avatar 
                            ? `<img src="${stats.avatar}" alt="avatar">` 
                            : '<div class="coc-edit-avatar-placeholder">ğŸ¦Œ</div>'}
                    </div>
                    <button class="coc-edit-avatar-btn" id="coc-avatar-upload-btn">ğŸ“· ä¸Šä¼ å¤´åƒ</button>
                    <input type="file" id="coc-avatar-input" accept="image/png,image/jpeg,image/gif,image/webp" style="display: none;">
                </div>
                
                <!-- èŒä¸šé€‰æ‹© -->
                <div>
                    <div class="coc-edit-label">èŒä¸š</div>
                    <select class="coc-edit-input coc-edit-occupation-select" id="coc-occupation-select">
                        <option value="">é€‰æ‹©èŒä¸š</option>
                        ${occupationNames.map(occName => 
                            `<option value="${occName}" ${occName === currentOccupation ? 'selected' : ''}>${occName}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <!-- æŠ€èƒ½ç‚¹æ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæ€»æ•°ï¼Œä¸å®æ—¶è®¡ç®—ï¼‰ -->
                <div class="coc-edit-grid" style="margin-top: 8px;">
                    <div>
                        <div class="coc-edit-label">èŒä¸šæŠ€èƒ½ç‚¹</div>
                        <div class="coc-stat-value" style="text-align:center;" id="occ-points-total">${occPoints}</div>
                    </div>
                    <div>
                        <div class="coc-edit-label">å…´è¶£æŠ€èƒ½ç‚¹</div>
                        <div class="coc-stat-value" style="text-align:center;" id="int-points-total">${intPoints}</div>
                    </div>
                </div>
                
                <!-- å¹´é¾„å’Œå¹´ä»½ -->
                <div class="coc-edit-grid" style="margin-top: 8px;">
                    <div>
                        <div class="coc-edit-label">æ€§åˆ«</div>
                        <select class="coc-edit-input coc-edit-gender" id="coc-edit-gender">
                            <option value="ç”·" ${stats.gender === 'ç”·' ? 'selected' : ''}>ç”·</option>
                            <option value="å¥³" ${stats.gender === 'å¥³' ? 'selected' : ''}>å¥³</option>
                            <option value="å…¶ä»–" ${stats.gender === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <div class="coc-edit-label">å‡ºç”Ÿå¹´ä»½</div>
                        <input type="number" class="coc-edit-input coc-edit-birth-year" id="coc-edit-birth-year" value="${stats.birthYear || 1890}" placeholder="1890">
                    </div>
                    <div>
                        <div class="coc-edit-label">å½“å‰å¹´ä»½</div>
                        <input type="number" class="coc-edit-input coc-edit-current-year" id="coc-edit-current-year" value="${stats.currentYear || 1925}" placeholder="1925">
                    </div>
                </div>
                
                <!-- å‡ºç”Ÿåœ°å’Œå±…ä½åœ° -->
                <div class="coc-edit-grid">
                    <div>
                        <div class="coc-edit-label">å‡ºç”Ÿåœ°</div>
                        <input type="text" class="coc-edit-input coc-edit-birthplace" value="${stats.birthplace || ''}">
                    </div>
                    <div>
                        <div class="coc-edit-label">å±…ä½åœ°</div>
                        <input type="text" class="coc-edit-input coc-edit-residence" value="${stats.residence || ''}">
                    </div>
                </div>

                <!-- å±æ€§ï¼ˆä¸å¯ç¼–è¾‘ï¼Œåªè¯»ï¼‰ -->
                <div class="coc-edit-label">å±æ€§ï¼ˆéšæœºç”Ÿæˆï¼Œä¸å¯ä¿®æ”¹ï¼‰</div>
                <div class="coc-edit-grid">
                    ${['STR', 'DEX', 'CON', 'APP', 'POW', 'SIZ', 'INT', 'EDU', 'LUCK'].map(attr => `
                        <div>
                            <div class="coc-edit-label">${attr}</div>
                            <input type="number" class="coc-edit-input" id="coc-attr-${attr}" value="${stats[attr] || 50}" readonly style="background:#555; color:#aaa;">
                        </div>
                    `).join('')}
                </div>

                <div class="coc-edit-label">èŒä¸šæŠ€èƒ½</div>
                <div id="coc-edit-occupational-skills" class="coc-select-list">
                    ${Object.entries(stats.occupationalSkills || {}).map(([skill, value]) => `
                        <div class="coc-select-row">
                            <select class="coc-edit-occ-skill-name">
                                <option value="">é€‰æ‹©æŠ€èƒ½</option>
                                ${renderSkillOptions(skill, 'occupational', currentOccupation)}
                            </select>
                            <input type="number" class="coc-edit-occ-skill-value" value="${value}" placeholder="æ•°å€¼">
                            <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                        </div>
                    `).join('')}
                </div>
                <button class="coc-add-btn" id="coc-add-occ-skill">+ æ·»åŠ èŒä¸šæŠ€èƒ½</button>

                <div class="coc-edit-label">å…´è¶£æŠ€èƒ½</div>
                <div id="coc-edit-interest-skills" class="coc-select-list">
                    ${Object.entries(stats.interestSkills || {}).map(([skill, value]) => `
                        <div class="coc-select-row">
                            <select class="coc-edit-int-skill-name">
                                <option value="">é€‰æ‹©æŠ€èƒ½</option>
                                ${renderSkillOptions(skill, 'interest', currentOccupation)}
                            </select>
                            <input type="number" class="coc-edit-int-skill-value" value="${value}" placeholder="æ•°å€¼">
                            <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                        </div>
                    `).join('')}
                </div>
                <button class="coc-add-btn" id="coc-add-int-skill">+ æ·»åŠ å…´è¶£æŠ€èƒ½</button>

                <div class="coc-edit-label">æ ¼æ–—æŠ€èƒ½</div>
                <div id="coc-edit-fighting-skills" class="coc-select-list">
                    ${Object.entries(stats.fightingSkills || {}).map(([skill, value]) => `
                        <div class="coc-select-row">
                            <select class="coc-edit-fight-skill-name">
                                <option value="">é€‰æ‹©æŠ€èƒ½</option>
                                ${renderSkillOptions(skill, 'fighting', currentOccupation)}
                            </select>
                            <input type="number" class="coc-edit-fight-skill-value" value="${value}" placeholder="æ•°å€¼">
                            <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                        </div>
                    `).join('')}
                </div>
                <button class="coc-add-btn" id="coc-add-fight-skill">+ æ·»åŠ æ ¼æ–—æŠ€èƒ½</button>

                <div class="coc-edit-label">æ­¦å™¨</div>
                <div id="coc-edit-weapons" class="coc-select-list">
                    ${(stats.weapons || []).map(weapon => `
                        <div class="coc-select-row" style="display: flex; gap: 4px; align-items: center;">
                            <select class="coc-edit-weapon-select" style="flex: 1; padding: 4px; font-size: 11px;">
                                <option value="">é€‰æ‹©</option>
                                ${renderWeaponOptions(weapon.name)}
                            </select>
                            <input type="text" class="coc-edit-weapon-skill" value="${weapon.skill}" placeholder="æŠ€èƒ½%" style="flex: 0.6; padding: 4px; font-size: 11px;">
                            <input type="text" class="coc-edit-weapon-damage" value="${weapon.damage}" placeholder="ä¼¤å®³" style="flex: 0.6; padding: 4px; font-size: 11px;">
                            <button class="coc-remove-btn" style="width: 20px; height: 20px; font-size: 10px;" onclick="this.parentElement.remove()">âœ–</button>
                        </div>
                    `).join('')}
                </div>
                <button class="coc-add-btn" id="coc-add-weapon">+ æ·»åŠ æ­¦å™¨</button>

                <div class="coc-edit-label">èƒŒæ™¯æ•…äº‹</div>
                <textarea class="coc-edit-textarea" id="coc-edit-backstory" rows="2">${stats.backstory || ''}</textarea>

                <div class="coc-edit-label">è£…å¤‡ç‰©å“</div>
                <div id="coc-edit-possessions" class="coc-select-list">
                    ${(stats.possessions || []).map(item => `
                        <div class="coc-edit-possession-row">
                            <input type="text" class="coc-edit-input coc-edit-possession-name" value="${item.name}" placeholder="ç‰©å“å" style="flex:1; padding:4px; font-size:11px;">
                            <input type="number" class="coc-edit-input coc-edit-possession-qty" value="${item.quantity || 1}" placeholder="æ•°é‡" style="width:60px; padding:4px; font-size:11px;">
                            <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                        </div>
                    `).join('')}
                </div>
                <button class="coc-add-btn" id="coc-add-possession">+ æ·»åŠ ç‰©å“</button>

                <div class="coc-edit-label">èµ„äº§</div>
                <div class="coc-edit-grid">
                    <div>
                        <div class="coc-edit-label">æ¶ˆè´¹æ°´å¹³</div>
                        <input type="text" class="coc-edit-input coc-edit-spending" value="${stats.assets?.spendingLevel || ''}">
                    </div>
                    <div>
                        <div class="coc-edit-label">ç°é‡‘</div>
                        <input type="text" class="coc-edit-input coc-edit-cash" value="${stats.assets?.cash || ''}">
                    </div>
                    <div>
                        <div class="coc-edit-label">èµ„äº§</div>
                        <input type="text" class="coc-edit-input coc-edit-assets" value="${stats.assets?.assets || ''}">
                    </div>
                </div>

                <!-- ç–¯ç‹‚ç—‡çŠ¶ -->
                <div class="coc-edit-label">ğŸ§  ç–¯ç‹‚ç—‡çŠ¶</div>
                <div id="coc-edit-insanity" class="coc-select-list">
                    ${(stats.insanity || []).map(ins => `
                        <div class="coc-edit-relationship-row">
                            <input type="text" class="coc-edit-input coc-edit-insanity-type" value="${ins.type}" placeholder="ç±»å‹ (ææƒ§ç—‡/èºç‹‚ç—‡)" style="flex:1; padding:4px;">
                            <input type="text" class="coc-edit-input coc-edit-insanity-desc" value="${ins.description}" placeholder="æè¿°" style="flex:1; padding:4px;">
                            <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                        </div>
                    `).join('')}
                </div>
                <button class="coc-add-btn" id="coc-add-insanity">+ æ·»åŠ ç–¯ç‹‚ç—‡çŠ¶</button>

                <div class="coc-edit-label">åŒä¼´å…³ç³»</div>
                <div id="coc-edit-relationships" class="coc-select-list">
                    ${(stats.relationships || []).map(rel => `
                        <div class="coc-edit-relationship-row">
                            <input type="text" class="coc-edit-input coc-edit-rel-name" value="${rel.name}" placeholder="å§“å" style="flex:1; padding:4px; font-size:11px;">
                            <input type="text" class="coc-edit-input coc-edit-rel-desc" value="${rel.relationship}" placeholder="å…³ç³»" style="flex:1; padding:4px; font-size:11px;">
                            <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                        </div>
                    `).join('')}
                </div>
                <button class="coc-add-btn" id="coc-add-relationship">+ æ·»åŠ å…³ç³»</button>

                <div class="coc-edit-actions">
                    <button class="coc-edit-save" id="coc-save-edit">ğŸ’¾ ä¿å­˜</button>
                    <button class="coc-edit-cancel" id="coc-cancel-edit">âœ– å–æ¶ˆ</button>
                </div>
            </div>
        `;
    }
    
    // ç»‘å®šç¼–è¾‘äº‹ä»¶
    function bindEditEvents() {
        // èŒä¸šé€‰æ‹©å˜æ›´äº‹ä»¶
        const occupationSelect = document.getElementById('coc-occupation-select');
        if (occupationSelect) {
            occupationSelect.addEventListener('change', (e) => {
                const newOccupation = e.target.value;
                if (newOccupation) {
                    // é‡æ–°è®¡ç®—æŠ€èƒ½ç‚¹æ˜¾ç¤º
                    const attributes = {
                        STR: currentEditStats.STR || 50,
                        DEX: currentEditStats.DEX || 50,
                        CON: currentEditStats.CON || 50,
                        APP: currentEditStats.APP || 50,
                        POW: currentEditStats.POW || 50,
                        INT: currentEditStats.INT || 50,
                        SIZ: currentEditStats.SIZ || 50,
                        EDU: currentEditStats.EDU || 50
                    };
                    
                    const occPoints = calculateOccupationPoints(newOccupation, attributes);
                    const intPoints = calculateInterestPoints(attributes.INT);
                    
                    document.getElementById('occ-points-total').textContent = occPoints;
                    document.getElementById('int-points-total').textContent = intPoints;
                    
                    // åˆ·æ–°èŒä¸šæŠ€èƒ½ä¸‹æ‹‰æ¡†
                    const occSkillContainer = document.getElementById('coc-edit-occupational-skills');
                    if (occSkillContainer) {
                        const rows = occSkillContainer.querySelectorAll('.coc-select-row');
                        rows.forEach(row => {
                            const select = row.querySelector('.coc-edit-occ-skill-name');
                            if (select) {
                                const currentValue = select.value;
                                const skillOptions = renderSkillOptions(currentValue, 'occupational', newOccupation);
                                select.innerHTML = `<option value="">é€‰æ‹©æŠ€èƒ½</option>${skillOptions}`;
                                select.value = currentValue;
                            }
                        });
                    }
                }
            });
        }
        
        // å¹´é¾„å˜æ›´äº‹ä»¶
        const birthYearInput = document.getElementById('coc-edit-birth-year');
        const currentYearInput = document.getElementById('coc-edit-current-year');
        
        function recalcAgeAndAttributes() {
            const birthYear = parseInt(birthYearInput.value) || 1890;
            const currentYear = parseInt(currentYearInput.value) || 1925;
            const age = currentYear - birthYear;
            
            // è·å–ä¿å­˜çš„åŸºç¡€å±æ€§
            const baseAttrs = {
                baseSTR: currentEditStats.baseSTR || currentEditStats.STR,
                baseDEX: currentEditStats.baseDEX || currentEditStats.DEX,
                baseCON: currentEditStats.baseCON || currentEditStats.CON,
                baseAPP: currentEditStats.baseAPP || currentEditStats.APP,
                basePOW: currentEditStats.basePOW || currentEditStats.POW,
                baseSIZ: currentEditStats.baseSIZ || currentEditStats.SIZ,
                baseINT: currentEditStats.baseINT || currentEditStats.INT,
                baseEDU: currentEditStats.baseEDU || currentEditStats.EDU,
                baseLUCK: currentEditStats.baseLUCK || currentEditStats.LUCK
            };
            
            // é‡æ–°åº”ç”¨å¹´é¾„ä¿®æ­£
            const newAttrs = applyAgeEffects(baseAttrs, age);
            
            // æ›´æ–°å½“å‰ç¼–è¾‘çŠ¶æ€
            currentEditStats.STR = newAttrs.STR;
            currentEditStats.DEX = newAttrs.DEX;
            currentEditStats.CON = newAttrs.CON;
            currentEditStats.APP = newAttrs.APP;
            currentEditStats.POW = newAttrs.POW;
            currentEditStats.SIZ = newAttrs.SIZ;
            currentEditStats.INT = newAttrs.INT;
            currentEditStats.EDU = newAttrs.EDU;
            currentEditStats.LUCK = newAttrs.LUCK;
            
            // æ›´æ–°UIä¸­çš„å±æ€§æ˜¾ç¤º
            document.getElementById('coc-attr-STR').value = newAttrs.STR;
            document.getElementById('coc-attr-DEX').value = newAttrs.DEX;
            document.getElementById('coc-attr-CON').value = newAttrs.CON;
            document.getElementById('coc-attr-APP').value = newAttrs.APP;
            document.getElementById('coc-attr-POW').value = newAttrs.POW;
            document.getElementById('coc-attr-SIZ').value = newAttrs.SIZ;
            document.getElementById('coc-attr-INT').value = newAttrs.INT;
            document.getElementById('coc-attr-EDU').value = newAttrs.EDU;
            document.getElementById('coc-attr-LUCK').value = newAttrs.LUCK;
            
            // é‡æ–°è®¡ç®—æŠ€èƒ½ç‚¹ï¼ˆå› ä¸ºEDUå¯èƒ½å˜åŒ–ï¼‰
            const occPoints = calculateOccupationPoints(currentEditStats.occupation, newAttrs);
            const intPoints = calculateInterestPoints(newAttrs.INT);
            document.getElementById('occ-points-total').textContent = occPoints;
            document.getElementById('int-points-total').textContent = intPoints;
        }
        
        if (birthYearInput && currentYearInput) {
            birthYearInput.addEventListener('change', recalcAgeAndAttributes);
            currentYearInput.addEventListener('change', recalcAgeAndAttributes);
        }
        
        // å¤´åƒä¸Šä¼ 
        const uploadBtn = document.getElementById('coc-avatar-upload-btn');
        const avatarInput = document.getElementById('coc-avatar-input');
        const avatarPreview = document.getElementById('coc-avatar-preview');
        
        if (uploadBtn && avatarInput) {
            uploadBtn.onclick = () => avatarInput.click();
            
            avatarInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleAvatarUpload(file, (avatarData) => {
                        currentEditStats.avatar = avatarData;
                        avatarPreview.innerHTML = `<img src="${avatarData}" alt="avatar">`;
                    });
                }
            };
        }

        // æ·»åŠ èŒä¸šæŠ€èƒ½
        const addOccSkill = document.getElementById('coc-add-occ-skill');
        if (addOccSkill) {
            addOccSkill.onclick = () => {
                const container = document.getElementById('coc-edit-occupational-skills');
                if (container) {
                    const occupationSelect = document.getElementById('coc-occupation-select');
                    const currentOccupation = occupationSelect ? occupationSelect.value : 'è°ƒæŸ¥å‘˜';
                    
                    const newRow = document.createElement('div');
                    newRow.className = 'coc-select-row';
                    newRow.innerHTML = `
                        <select class="coc-edit-occ-skill-name">
                            <option value="">é€‰æ‹©æŠ€èƒ½</option>
                            ${renderSkillOptions('', 'occupational', currentOccupation)}
                        </select>
                        <input type="number" class="coc-edit-occ-skill-value" value="50" placeholder="æ•°å€¼">
                        <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                    `;
                    container.appendChild(newRow);
                }
            };
        }

        // æ·»åŠ å…´è¶£æŠ€èƒ½
        const addIntSkill = document.getElementById('coc-add-int-skill');
        if (addIntSkill) {
            addIntSkill.onclick = () => {
                const container = document.getElementById('coc-edit-interest-skills');
                if (container) {
                    const newRow = document.createElement('div');
                    newRow.className = 'coc-select-row';
                    newRow.innerHTML = `
                        <select class="coc-edit-int-skill-name">
                            <option value="">é€‰æ‹©æŠ€èƒ½</option>
                            ${SKILLS_LIST.interest.map(skill => `<option value="${skill}">${skill}</option>`).join('')}
                        </select>
                        <input type="number" class="coc-edit-int-skill-value" value="50" placeholder="æ•°å€¼">
                        <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                    `;
                    container.appendChild(newRow);
                }
            };
        }

        // æ·»åŠ æ ¼æ–—æŠ€èƒ½
        const addFightSkill = document.getElementById('coc-add-fight-skill');
        if (addFightSkill) {
            addFightSkill.onclick = () => {
                const container = document.getElementById('coc-edit-fighting-skills');
                if (container) {
                    const newRow = document.createElement('div');
                    newRow.className = 'coc-select-row';
                    newRow.innerHTML = `
                        <select class="coc-edit-fight-skill-name">
                            <option value="">é€‰æ‹©æŠ€èƒ½</option>
                            ${SKILLS_LIST.fighting.map(skill => `<option value="${skill}">${skill}</option>`).join('')}
                        </select>
                        <input type="number" class="coc-edit-fight-skill-value" value="50" placeholder="æ•°å€¼">
                        <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                    `;
                    container.appendChild(newRow);
                }
            };
        }

        // æ·»åŠ æ­¦å™¨
        const addWeapon = document.getElementById('coc-add-weapon');
        if (addWeapon) {
            addWeapon.onclick = () => {
                const container = document.getElementById('coc-edit-weapons');
                if (container) {
                    const newRow = document.createElement('div');
                    newRow.className = 'coc-select-row';
                    newRow.style.cssText = 'display: flex; gap: 4px; align-items: center; margin-bottom: 4px;';
                    newRow.innerHTML = `
                        <select class="coc-edit-weapon-select" style="flex:1; padding:4px; font-size:11px;">
                            <option value="">é€‰æ‹©æ­¦å™¨</option>
                            ${WEAPONS_LIST.map(w => `<option value="${w.name}" data-skill="${w.skill}" data-damage="${w.damage}">${w.name}</option>`).join('')}
                        </select>
                        <input type="text" class="coc-edit-weapon-skill" placeholder="æŠ€èƒ½%" style="flex:0.6; padding:4px; font-size:11px;">
                        <input type="text" class="coc-edit-weapon-damage" placeholder="ä¼¤å®³" style="flex:0.6; padding:4px; font-size:11px;">
                        <button class="coc-remove-btn" style="width:20px; height:20px; font-size:10px;" onclick="this.parentElement.remove()">âœ–</button>
                    `;
                    container.appendChild(newRow);

                    newRow.querySelector('.coc-edit-weapon-select').addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        const skillInput = newRow.querySelector('.coc-edit-weapon-skill');
                        const damageInput = newRow.querySelector('.coc-edit-weapon-damage');
                        if (selectedOption.dataset.skill) {
                            skillInput.value = selectedOption.dataset.skill;
                        }
                        if (selectedOption.dataset.damage) {
                            damageInput.value = selectedOption.dataset.damage;
                        }
                    });
                }
            };
        }

        // æ·»åŠ ç‰©å“
        const addPossession = document.getElementById('coc-add-possession');
        if (addPossession) {
            addPossession.onclick = () => {
                const container = document.getElementById('coc-edit-possessions');
                if (container) {
                    const newRow = document.createElement('div');
                    newRow.className = 'coc-edit-possession-row';
                    newRow.style.cssText = 'display: flex; gap: 4px; margin-bottom: 4px; align-items: center;';
                    newRow.innerHTML = `
                        <input type="text" class="coc-edit-input coc-edit-possession-name" placeholder="ç‰©å“å" style="flex:1; padding:4px; font-size:11px;">
                        <input type="number" class="coc-edit-input coc-edit-possession-qty" value="1" placeholder="æ•°é‡" style="width:60px; padding:4px; font-size:11px;">
                        <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                    `;
                    container.appendChild(newRow);
                }
            };
        }

        // æ·»åŠ ç–¯ç‹‚ç—‡çŠ¶æŒ‰é’®
        const addInsanity = document.getElementById('coc-add-insanity');
        if (addInsanity) {
            addInsanity.onclick = () => {
                const container = document.getElementById('coc-edit-insanity');
                if (container) {
                    const newRow = document.createElement('div');
                    newRow.className = 'coc-edit-relationship-row';
                    newRow.innerHTML = `
                        <input type="text" class="coc-edit-input coc-edit-insanity-type" placeholder="ææƒ§ç—‡/èºç‹‚ç—‡" style="flex:1; padding:4px;">
                        <input type="text" class="coc-edit-input coc-edit-insanity-desc" placeholder="æè¿°" style="flex:1; padding:4px;">
                        <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                    `;
                    container.appendChild(newRow);
                }
            };
        }

        // æ·»åŠ å…³ç³»
        const addRelationship = document.getElementById('coc-add-relationship');
        if (addRelationship) {
            addRelationship.onclick = () => {
                const container = document.getElementById('coc-edit-relationships');
                if (container) {
                    const newRow = document.createElement('div');
                    newRow.className = 'coc-edit-relationship-row';
                    newRow.style.cssText = 'display: flex; gap: 4px; margin-bottom: 4px; align-items: center;';
                    newRow.innerHTML = `
                        <input type="text" class="coc-edit-input coc-edit-rel-name" placeholder="å§“å" style="flex:1; padding:4px; font-size:11px;">
                        <input type="text" class="coc-edit-input coc-edit-rel-desc" placeholder="å…³ç³»" style="flex:1; padding:4px; font-size:11px;">
                        <button class="coc-remove-btn" onclick="this.parentElement.remove()">âœ–</button>
                    `;
                    container.appendChild(newRow);
                }
            };
        }

        // ä¸ºå·²æœ‰çš„æ­¦å™¨é€‰æ‹©æ¡†ç»‘å®šè‡ªåŠ¨å¡«å……äº‹ä»¶
        document.querySelectorAll('.coc-edit-weapon-select').forEach(select => {
            select.addEventListener('change', function() {
                const row = this.closest('.coc-select-row');
                const selectedOption = this.options[this.selectedIndex];
                if (row) {
                    const skillInput = row.querySelector('.coc-edit-weapon-skill');
                    const damageInput = row.querySelector('.coc-edit-weapon-damage');
                    if (selectedOption.dataset.skill) {
                        skillInput.value = selectedOption.dataset.skill;
                    }
                    if (selectedOption.dataset.damage) {
                        damageInput.value = selectedOption.dataset.damage;
                    }
                }
            });
        });

        // ä¿å­˜ç¼–è¾‘
        const saveEdit = document.getElementById('coc-save-edit');
        if (saveEdit) {
            saveEdit.onclick = () => {
                const newStats = collectEditData();
                
                if (currentEditStats.avatar) {
                    newStats.avatar = currentEditStats.avatar;
                }
                
                data.set(currentEditName, newStats);
                
                isEditing = false;
                const display = document.getElementById('coc-stats-display');
                if (display) display.style.display = 'block';
                
                const editSection = document.getElementById('coc-edit-section');
                if (editSection) editSection.style.display = 'none';
                
                if (display) {
                    display.innerHTML = renderCharacterCard(currentEditName, newStats);
                    
                    setTimeout(() => {
                        const editBtn = document.getElementById('coc-edit-mode-btn');
                        if (editBtn) {
                            editBtn.onclick = () => {
                                enterEditMode(currentEditName, newStats);
                            };
                        }
                    }, 50);
                }
            };
        }

        // å–æ¶ˆç¼–è¾‘
        const cancelEdit = document.getElementById('coc-cancel-edit');
        if (cancelEdit) {
            cancelEdit.onclick = () => {
                isEditing = false;
                const display = document.getElementById('coc-stats-display');
                if (display) display.style.display = 'block';
                
                const editSection = document.getElementById('coc-edit-section');
                if (editSection) editSection.style.display = 'none';
            };
        }
    }
    
    // æ”¶é›†ç¼–è¾‘æ•°æ®
    function collectEditData() {
        const stats = { ...currentEditStats };

        stats.occupation = document.getElementById('coc-occupation-select')?.value || 'è°ƒæŸ¥å‘˜';
        stats.gender = document.querySelector('.coc-edit-gender')?.value || 'ç”·';
        stats.birthYear = parseInt(document.getElementById('coc-edit-birth-year')?.value) || 1890;
        stats.currentYear = parseInt(document.getElementById('coc-edit-current-year')?.value) || 1925;

        // èŒä¸šæŠ€èƒ½
        const occupationalSkills = {};
        document.querySelectorAll('#coc-edit-occupational-skills .coc-select-row').forEach(row => {
            const select = row.querySelector('.coc-edit-occ-skill-name');
            const valueInput = row.querySelector('.coc-edit-occ-skill-value');
            if (select && valueInput && select.value) {
                occupationalSkills[select.value] = parseInt(valueInput.value) || 50;
            }
        });
        if (Object.keys(occupationalSkills).length > 0) {
            stats.occupationalSkills = occupationalSkills;
        }

        // å…´è¶£æŠ€èƒ½
        const interestSkills = {};
        document.querySelectorAll('#coc-edit-interest-skills .coc-select-row').forEach(row => {
            const select = row.querySelector('.coc-edit-int-skill-name');
            const valueInput = row.querySelector('.coc-edit-int-skill-value');
            if (select && valueInput && select.value) {
                interestSkills[select.value] = parseInt(valueInput.value) || 50;
            }
        });
        if (Object.keys(interestSkills).length > 0) {
            stats.interestSkills = interestSkills;
        }

        // æ ¼æ–—æŠ€èƒ½
        const fightingSkills = {};
        document.querySelectorAll('#coc-edit-fighting-skills .coc-select-row').forEach(row => {
            const select = row.querySelector('.coc-edit-fight-skill-name');
            const valueInput = row.querySelector('.coc-edit-fight-skill-value');
            if (select && valueInput && select.value) {
                fightingSkills[select.value] = parseInt(valueInput.value) || 50;
            }
        });
        if (Object.keys(fightingSkills).length > 0) {
            stats.fightingSkills = fightingSkills;
        }

        // æ­¦å™¨
        const weapons = [];
        document.querySelectorAll('#coc-edit-weapons .coc-select-row').forEach(row => {
            const select = row.querySelector('.coc-edit-weapon-select');
            const skillInput = row.querySelector('.coc-edit-weapon-skill');
            const damageInput = row.querySelector('.coc-edit-weapon-damage');
            if (select && select.value) {
                weapons.push({
                    name: select.value,
                    skill: skillInput?.value || '',
                    damage: damageInput?.value || ''
                });
            }
        });
        if (weapons.length > 0) {
            stats.weapons = weapons;
        }

        stats.backstory = document.getElementById('coc-edit-backstory')?.value || '';

        // è£…å¤‡ç‰©å“
        const possessions = [];
        document.querySelectorAll('#coc-edit-possessions .coc-edit-possession-row').forEach(row => {
            const nameInput = row.querySelector('.coc-edit-possession-name');
            const qtyInput = row.querySelector('.coc-edit-possession-qty');
            if (nameInput && nameInput.value.trim()) {
                possessions.push({
                    name: nameInput.value.trim(),
                    quantity: parseInt(qtyInput?.value) || 1
                });
            }
        });
        if (possessions.length > 0) {
            stats.possessions = possessions;
        }

        stats.assets = {
            spendingLevel: document.querySelector('.coc-edit-spending')?.value || '',
            cash: document.querySelector('.coc-edit-cash')?.value || '',
            assets: document.querySelector('.coc-edit-assets')?.value || ''
        };

        // ç–¯ç‹‚ç—‡çŠ¶
        const insanity = [];
        document.querySelectorAll('#coc-edit-insanity .coc-edit-relationship-row').forEach(row => {
            const typeInput = row.querySelector('.coc-edit-insanity-type');
            const descInput = row.querySelector('.coc-edit-insanity-desc');
            if (typeInput && typeInput.value.trim()) {
                insanity.push({
                    type: typeInput.value.trim(),
                    description: descInput?.value.trim() || ''
                });
            }
        });
        if (insanity.length > 0) {
            stats.insanity = insanity;
        }

        // åŒä¼´å…³ç³»
        const relationships = [];
        document.querySelectorAll('#coc-edit-relationships .coc-edit-relationship-row').forEach(row => {
            const nameInput = row.querySelector('.coc-edit-rel-name');
            const relInput = row.querySelector('.coc-edit-rel-desc');
            if (nameInput && nameInput.value.trim() && relInput && relInput.value.trim()) {
                relationships.push({
                    name: nameInput.value.trim(),
                    relationship: relInput.value.trim()
                });
            }
        });
        if (relationships.length > 0) {
            stats.relationships = relationships;
        }

        // é‡æ–°è®¡ç®—HPå’ŒSAN
        stats.HP = Math.floor((stats.CON + stats.SIZ) / 10);
        stats.SAN = stats.POW;

        return stats;
    }
    
    // å¯¼å…¥æ–‡ä»¶
    function importFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const jsonData = JSON.parse(event.target.result);
                    
                    let name, stats;
                    if (jsonData.character && jsonData.stats) {
                        name = jsonData.character;
                        stats = jsonData.stats;
                    } else {
                        name = file.name.replace('.json', '').replace(/-coc-stats$/, '');
                        stats = jsonData;
                    }
                    
                    data.set(name, stats);
                    renderViewMode();
                    
                    setTimeout(() => {
                        const select = document.getElementById('coc-role-select');
                        if (select) {
                            select.value = name;
                            select.dispatchEvent(new Event('change'));
                        }
                    }, 100);
                    
                } catch (error) {
                    alert(`âŒ å¯¼å…¥å¤±è´¥: ${error.message}`);
                }
            };
            reader.readAsText(file);
        };
        
        input.click();
    }
    
    // å¯¼å‡ºè§’è‰²
    function exportCharacter() {
        const select = document.getElementById('coc-role-select');
        if (!select) return;
        
        const name = select.value;
        if (!name) {
            alert('âŒ è¯·å…ˆé€‰æ‹©è§’è‰²');
            return;
        }
        
        const char = data.get(name);
        if (!char) return;
        
        const exportData = {
            character: name,
            stats: char.stats,
            exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}-coc-stats.json`;
        a.click();
    }
    
    // åˆ é™¤è§’è‰²
    function deleteCharacter() {
        const select = document.getElementById('coc-role-select');
        if (!select) return;
        
        const name = select.value;
        
        if (!name) {
            alert('âŒ è¯·å…ˆé€‰æ‹©è§’è‰²');
            return;
        }
        
        if (confirm(`ç¡®å®šåˆ é™¤ ${name} å—ï¼Ÿ`)) {
            data.delete(name);
            renderViewMode();
        }
    }
    
    // æ„å»ºUI
    function buildUI() {
        const winWidth = window.innerWidth;
        const winHeight = window.innerHeight;
        
        const topBar = document.querySelector('[class*="header"]') || document.querySelector('[class*="top"]');
        const topBarHeight = topBar ? topBar.getBoundingClientRect().height : 0;
        const safeTop = topBarHeight + 5;
        
        fetch('/scripts/extensions/third-party/SillyTavern-CoC/templates/character-panel.html')
            .then(response => response.text())
            .then(html => {
                document.body.insertAdjacentHTML('beforeend', html);
                panelElement = document.getElementById('coc-panel');
                
                if (!panelElement) return;
                
                const panelTop = safeTop;
                const panelLeft = 10;
                const panelWidth = winWidth - 20;
                const panelHeight = 500;
                
                panelElement.style.top = panelTop + 'px';
                panelElement.style.left = panelLeft + 'px';
                panelElement.style.width = panelWidth + 'px';
                panelElement.style.height = panelHeight + 'px';
                
                const closeBtn = document.getElementById('coc-close-panel');
                if (closeBtn) {
                    closeBtn.onclick = (e) => {
                        e.stopPropagation();
                        panelElement.style.display = 'none';
                    };
                }
                
                bindToolbarEvents();
                renderViewMode();
            })
            .catch(err => {
                console.error('[COC] åŠ è½½æ¨¡æ¿å¤±è´¥:', err);
            });
    }
    
    // æˆé•¿é¢æ¿å‡½æ•°ï¼ˆå¯é€‰ï¼‰
    function renderGrowthPanel(name, stats) {
        const usedSkills = stats.usedSkills || [];
        
        return `
            <div class="coc-edit-section">
                <div class="coc-edit-title">ğŸ“ˆ å¹•é—´æˆé•¿ - ${name}</div>
                <div class="coc-edit-label">æœ¬æ¬¡å‰§æœ¬ä½¿ç”¨è¿‡çš„æŠ€èƒ½ï¼š</div>
                <div id="coc-used-skills" class="coc-select-list">
                    ${usedSkills.length > 0 ? usedSkills.map(skill => `
                        <div class="coc-select-row">
                            <span class="coc-skill-name">${skill}</span>
                            <span class="coc-skill-value">${stats.skills?.[skill] || 0}%</span>
                            <button class="coc-btn small" onclick="applySkillGrowth('${name}', '${skill}')">ğŸ“ˆ æˆé•¿</button>
                        </div>
                    `).join('') : '<div style="color: #8e7c68;">æœ¬æ¬¡å‰§æœ¬æœªä½¿ç”¨æŠ€èƒ½</div>'}
                </div>
                <button class="coc-add-btn" id="coc-mark-skill-btn">â• æ‰‹åŠ¨æ ‡è®°æŠ€èƒ½ä½¿ç”¨</button>
                <div class="coc-edit-actions">
                    <button class="coc-edit-save" id="coc-growth-done">å®Œæˆ</button>
                </div>
            </div>
        `;
    }
    
    // åº”ç”¨æŠ€èƒ½æˆé•¿
    function applySkillGrowth(characterName, skillName) {
        const char = data.get(characterName);
        if (!char) return;
        
        const currentValue = char.stats.skills?.[skillName] || 50;
        const roll = rollD100();
        
        if (roll > currentValue) {
            const increase = Math.floor(Math.random() * 10) + 1;
            const newValue = currentValue + increase;
            
            if (!char.stats.skills) char.stats.skills = {};
            char.stats.skills[skillName] = newValue;
            
            if (char.stats.usedSkills) {
                char.stats.usedSkills = char.stats.usedSkills.filter(s => s !== skillName);
            }
            
            data.save();
            
            alert(`âœ… ${skillName} æˆé•¿æˆåŠŸï¼ ${currentValue}% â†’ ${newValue}% (+${increase})`);
        } else {
            alert(`âŒ ${skillName} æˆé•¿å¤±è´¥ï¼Œæœªèƒ½çªç ´å½“å‰å€¼`);
        }
    }
    
    // æš´éœ²å…¨å±€å‡½æ•°
    window.applySkillGrowth = applySkillGrowth;
    
    return buildUI;
}
